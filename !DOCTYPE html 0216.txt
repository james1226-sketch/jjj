import React, { useState, useEffect, useRef, useMemo, useCallback } from 'react';
import { 
  BarChart3, TrendingUp, Users, Briefcase, Activity, Search, ExternalLink, 
  PieChart, ArrowUpRight, Info, ClipboardList, Zap, BookOpen, GraduationCap, 
  Target, ShieldCheck, Layers, Percent, Scale, Coins, LineChart, BarChart4, 
  RotateCw, TrendingDown, DollarSign, Award, AlertTriangle, CalendarClock, Globe,
  Table, Newspaper, Megaphone, ArrowLeftRight, Signal, Banknote, Triangle,
  Sparkles, Bot, Send, MessageSquare, RefreshCw, Star, MapPin, SlidersHorizontal,
  XCircle, LayoutDashboard, ChevronDown, CheckCircle2, MonitorPlay, Maximize2,
  CandlestickChart, MousePointerClick, Youtube, Clapperboard, PlayCircle,
  Trophy, Flame, Plus, Trash2, ListChecks, Gauge,
  Settings, Download, Upload, Copy, Clock, CalendarDays,
  Book, ArrowRight, Network, Radar, Cpu, CircuitBoard, Server, Car, Map as MapIcon, 
  Factory, BatteryCharging, Monitor, Layers2, Paperclip, Image as ImageIcon,
  Crosshair, ShieldAlert, Microscope, ThermometerSun, Loader2, FileSearch, Link as LinkIcon,
  Filter, Play, BarChart2, CheckSquare, Radio, ScanLine, Sigma,
  Sliders, RefreshCcw, Binary, Disc, Hash, Zap as ZapIcon,
  CloudLightning, Droplets, Wind, MoveRight
} from 'lucide-react';

// ====================================================================================
//  GLOBAL STYLES (Injected Component)
// ====================================================================================

const GlobalStyles = () => (
  <style>{`
    @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
    
    body { font-family: 'Noto Sans TC', sans-serif; background-color: #0f172a; color: #f8fafc; }
    .font-mono { font-family: 'JetBrains Mono', monospace; }
    
    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #1e293b; }
    ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #64748b; }
    
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    
    .animate-fadeIn { animation: fadeIn 0.5s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .btn-neon-breathing { animation: neonPulse 3s infinite; }
    @keyframes neonPulse { 0%, 100% { box-shadow: 0 0 5px rgba(244, 63, 94, 0.2), 0 0 10px rgba(244, 63, 94, 0.2); } 50% { box-shadow: 0 0 10px rgba(244, 63, 94, 0.5), 0 0 20px rgba(244, 63, 94, 0.3); } }

    .dashboard-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    
    .thermometer-gradient { background: linear-gradient(90deg, #22c55e 0%, #eab308 50%, #ef4444 100%); }
    
    /* Sector Wheel Quadrants */
    .sector-quadrant { transition: all 0.3s ease; }
    .sector-quadrant:hover { filter: brightness(1.1); transform: scale(1.02); }
  `}</style>
);

// ====================================================================================
//  GEMINI API CONFIGURATION
// ====================================================================================

// âš ï¸ è³‡å®‰æé†’ï¼šè‹¥è¦éƒ¨ç½²åˆ°å…¬é–‹ç¶²è·¯ (Public URL)ï¼Œè«‹å‹™å¿…åˆ° Google Cloud Console è¨­å®š API Key é™åˆ¶ (HTTP Referrer)ï¼Œ
// é™å®šåªæœ‰æ‚¨çš„ç¶²åŸŸå¯ä»¥ä½¿ç”¨æ­¤ Keyï¼Œé¿å…é¡åº¦è¢«ä»–äººç›œç”¨ã€‚
const apiKey = "AIzaSyABQDF59xBULhH7guwl3E4Dvt4i7FRg9ng"; 

// è¼”åŠ©å‡½å¼ï¼šå¼·å¥çš„ JSON è§£æå™¨ (v4.0 çµ‚æ¥µä¿®å¾©ç‰ˆ)
const safeParseJSON = (text) => {
    try {
        if (!text) return null;
        
        // å„ªå…ˆå˜—è©¦æå– Markdown JSONå€å¡Š
        const jsonBlockMatch = text.match(/```json\s*([\s\S]*?)\s*```/);
        if (jsonBlockMatch && jsonBlockMatch[1]) {
            try {
                return JSON.parse(jsonBlockMatch[1]);
            } catch (e) {
                // å¦‚æœå€å¡Šå…§è§£æå¤±æ•—ï¼Œç¹¼çºŒå¾€ä¸‹å˜—è©¦
            }
        }

        // æœå°‹æœ€å¤–å±¤çš„ {} æˆ– []
        const firstOpenBrace = text.indexOf('{');
        const firstOpenBracket = text.indexOf('[');
        let start = -1;
        
        // æ±ºå®šæ˜¯ç‰©ä»¶é‚„æ˜¯é™£åˆ—é–‹å§‹å¾—æ¯”è¼ƒæ—©
        if (firstOpenBrace !== -1 && firstOpenBracket !== -1) {
            start = Math.min(firstOpenBrace, firstOpenBracket);
        } else {
            start = firstOpenBrace !== -1 ? firstOpenBrace : firstOpenBracket;
        }

        if (start === -1) return null; // æ‰¾ä¸åˆ°ä»»ä½• JSON çµæ§‹

        // å°‹æ‰¾å°æ‡‰çš„çµæŸç¬¦è™Ÿ
        const lastCloseBrace = text.lastIndexOf('}');
        const lastCloseBracket = text.lastIndexOf(']');
        let end = -1;

        if (lastCloseBrace !== -1 && lastCloseBracket !== -1) {
            end = Math.max(lastCloseBrace, lastCloseBracket);
        } else {
            end = lastCloseBrace !== -1 ? lastCloseBrace : lastCloseBracket;
        }

        if (end > start) {
            const potentialJson = text.substring(start, end + 1);
            return JSON.parse(potentialJson);
        }
        
        return null;
    } catch (e) {
        console.error("JSON Parsing Failed:", e);
        return null;
    }
};

async function callGeminiAPI(prompt, images = [], systemPrompt = null, useSearch = false, jsonMode = false) {
    const models = ["gemini-2.5-flash-preview-09-2025", "gemini-2.0-flash-exp"]; 
    const maxRetries = 3;
    const parts = [{ text: prompt }];
    if (images && Array.isArray(images) && images.length > 0) {
        images.forEach(imageBase64 => {
            if (typeof imageBase64 === 'string' && imageBase64.includes(',')) {
                const mimeType = imageBase64.substring(5, imageBase64.indexOf(';'));
                const data = imageBase64.substring(imageBase64.indexOf(',') + 1);
                parts.push({ inlineData: { mimeType: mimeType, data: data } });
            }
        });
    }
    const defaultSystemPrompt = "ä½ æ˜¯ä¸€ä½ç²¾é€šç¾è‚¡èˆ‡å°è‚¡é€£å‹•é—œä¿‚çš„è³‡æ·±å¤œç›¤åˆ†æå¸« JAMESã€‚";
    const payload = {
        contents: [{ parts: parts }],
        systemInstruction: { parts: [{ text: systemPrompt || defaultSystemPrompt }] }
    };
    if (useSearch) { payload.tools = [{ google_search: {} }]; }
    if (jsonMode && !useSearch) { payload.generationConfig = { responseMimeType: "application/json" }; }

    let lastError = null;
    for (let attempt = 0; attempt <= maxRetries; attempt++) {
        for (const model of models) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (response.status === 429 || response.status === 503) {
                    await new Promise(resolve => setTimeout(resolve, Math.pow(2, attempt) * 1000));
                    continue;
                }
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                let text = data.candidates?.[0]?.content?.parts?.[0]?.text || "";
                if (!text) throw new Error("API å›å‚³å…§å®¹ç‚ºç©º");
                return text;
            } catch (error) { lastError = error; }
        }
    }
    throw lastError || new Error("All AI models failed to respond.");
}

// ====================================================================================
//  DATA CONSTANTS
// ====================================================================================

let GLOBAL_NEWS_CACHE = { data: null, timestamp: 0, CACHE_DURATION: 5 * 60 * 1000 };
const INITIAL_THEME_DATABASE = {
    'ai_server': {
        id: 'ai_server', name: 'AI ä¼ºæœå™¨ (ç¤ºç¯„)', desc: 'NVIDIA GB200 å‡ºè²¨åœ¨å³ï¼Œä¾›æ‡‰éˆç‡Ÿæ”¶çˆ†ç™¼', hypeScore: 95, stage: 'ä¸»å‡æ®µ', catalyst: 'CSP å¤§å» è³‡æœ¬æ”¯å‡ºå¢åŠ ',
        segmentAnalysis: {
            upstream: { heat: 95, status: 'ğŸ”¥ ç¼ºè²¨', desc: 'GPU èˆ‡ CoWoS', stocks: [{ code: '2330', name: 'å°ç©é›»', role: 'æ™¶åœ“ä»£å·¥', isLeader: true, flow: 'å¤–è³‡è²·è¶…', note: 'å…ˆé€²å°è£ç”¢èƒ½æ»¿è¼‰' }] },
            midstream: { heat: 88, status: 'ğŸ“ˆ å¼·å‹¢', desc: 'æ•£ç†±èˆ‡æ»‘è»Œ', stocks: [{ code: '3017', name: 'å¥‡é‹', role: 'æ•£ç†±', isLeader: true, flow: 'æŠ•ä¿¡è²·è¶…', note: 'æ°´å†·æ¿å‡ºè²¨' }] },
            downstream: { heat: 92, status: 'âš¡ çˆ†ç™¼', desc: 'çµ„è£ä»£å·¥', stocks: [{ code: '2317', name: 'é´»æµ·', role: 'çµ„è£', isLeader: true, flow: 'ä¸»åŠ›é–ç¢¼', note: 'GB200 æœ€å¤§ä»½é¡' }] }
        }
    }
};
const STATIC_NEWS_FALLBACK = [{ id: 1, title: "æ­£åœ¨é€£ç·š Google Search æƒææœ€æ–°é¡Œæ...", tag: "loading", time: "æƒæä¸­...", reliability: "high", source: "System" }];
const KNOWLEDGE_ITEMS = [
    { title: "ç¶œåˆè©•åˆ†", icon: <Target className="w-8 h-8 text-pink-400" />, summary: "ç³»çµ±é‹ç®—çš„ç¸½é«”æª¢åˆ†æ•¸ï¼Œè¶Šé«˜è¶Šå¥½ã€‚", details: ["åŒ…å«æŠ€è¡“ã€åŸºæœ¬ã€ç±Œç¢¼é¢å…±5é …æ¢ä»¶ã€‚", "5åˆ†ä»¥ä¸ŠåŠæ ¼ï¼Œ7åˆ†ä»¥ä¸Šå¼·å‹¢ã€‚", "åˆ†æ•¸ç”±ä½ç¿»é«˜ä»£è¡¨è½‰å¼·ã€‚"] },
    { title: "èè³‡é¤˜é¡ (è³‡é¤˜)", icon: <Users className="w-8 h-8 text-blue-400" />, summary: "æ•£æˆ¶ä¿¡å¿ƒæŒ‡æ¨™ (å€ŸéŒ¢è²·è‚¡)ã€‚", details: ["è³‡é¤˜å¢åŠ ï¼šæ•£æˆ¶çœ‹å¤šï¼Œç±Œç¢¼è¶¨æ–¼å‡Œäº‚(ä¸ç©©å®š)ã€‚", "è³‡é¤˜æ¸›å°‘ï¼šæ•£æˆ¶é›¢å ´æˆ–åœæï¼Œæœ‰åŠ©ç±Œç¢¼æ²‰æ¾±ã€‚", "ä¸»åŠ›å¸¸åœ¨èè³‡å¤§æ¸›(æ–·é ­)æ™‚é€²å ´æ’¿ä¾¿å®œã€‚"] },
    { title: "èåˆ¸é¤˜é¡ (åˆ¸é¤˜)", icon: <Scale className="w-8 h-8 text-indigo-400" />, summary: "ç©ºæ–¹ç‡ƒæ–™æŒ‡æ¨™ (å€Ÿåˆ¸è³£å‡º)ã€‚", details: ["åˆ¸é¤˜å¢åŠ ï¼šçœ‹ç©ºè€…è®Šå¤šï¼Œé€™ä¹Ÿæ˜¯æœªä¾†çš„è²·ç›¤(å›è£œ)ã€‚", "åˆ¸é¤˜æ¸›å°‘ï¼šç©ºå–®èªè¼¸å›è£œï¼Œæˆ–ç²åˆ©äº†çµã€‚", "åˆ¸é¤˜åœ¨é«˜æª”ä¸é€€ï¼Œè‚¡åƒ¹å»æ¼²ï¼Œæ˜“ç™¼ç”Ÿã€Œè»‹ç©ºã€ã€‚"] },
    { title: "åˆ¸è³‡æ¯”", icon: <ArrowUpRight className="w-8 h-8 text-red-400" />, summary: "åˆ¤æ–·æ˜¯å¦æœ‰ã€Œè»‹ç©ºã€è¡Œæƒ…çš„é—œéµã€‚", details: ["å…¬å¼ï¼šèåˆ¸é¤˜é¡ / èè³‡é¤˜é¡ X 100%ã€‚", "æ¯”å€¼è¶Šé«˜ï¼Œä»£è¡¨ç©ºå–®æ¯”ä¾‹è¶Šé«˜ã€‚", "é€šå¸¸è¶…é 30% å³å…·å‚™è»‹ç©ºæ¢ä»¶ã€‚"] },
    { title: "ç¾é‡‘æ®–åˆ©ç‡", icon: <Percent className="w-8 h-8 text-yellow-400" />, summary: "å­˜è‚¡æ—æœ€æ„›ï¼Œå®‰å…¨å ±é…¬ç‡ã€‚", details: ["å…¬å¼ï¼šç¾é‡‘è‚¡åˆ© / è‚¡åƒ¹ã€‚", "è¶Šé«˜ä»£è¡¨é ˜çš„åˆ©æ¯è¶Šå¤šã€‚", "éœ€æ³¨æ„æ˜¯å¦èƒ½å¡«æ¯ã€‚"] },
    { title: "æœ¬ç›Šæ¯” (PE)", icon: <Scale className="w-8 h-8 text-blue-400" />, summary: "åˆ¤æ–·è‚¡åƒ¹æ˜¯ä¾¿å®œé‚„æ˜¯æ˜‚è²´ã€‚", details: ["å…¬å¼ï¼šè‚¡åƒ¹ / EPSã€‚", "ä½PEï¼šè‚¡åƒ¹ç›¸å°ä¾¿å®œ (åƒ¹å€¼è‚¡)ã€‚", "é«˜PEï¼šå¸‚å ´çµ¦äºˆé«˜æœŸå¾… (æˆé•·è‚¡)ã€‚"] },
    { title: "è‚¡åƒ¹æ·¨å€¼æ¯” (PB)", icon: <Coins className="w-8 h-8 text-indigo-400" />, summary: "ä½æ–¼1ä»£è¡¨è·Œç ´æ·¨å€¼ã€‚", details: ["å…¬å¼ï¼šè‚¡åƒ¹ / æ¯è‚¡æ·¨å€¼ã€‚", "å°æ–¼1é€šå¸¸è¦–ç‚ºåƒ¹å€¼è¢«ä½ä¼°ã€‚", "é©åˆç”¨ä¾†è©•ä¼°æ™¯æ°£å¾ªç’°è‚¡ã€‚"] },
    { title: "æ©Ÿæ§‹é ä¼° EPS", icon: <LineChart className="w-8 h-8 text-cyan-400" />, summary: "æ³•äººå°æœªä¾†çš„ç²åˆ©å…±è­˜ã€‚", details: ["å¤–è³‡æŠ•ä¿¡å°æœªä¾†çš„ç²åˆ©é ä¼°å¹³å‡ã€‚", "é ä¼°å€¼ä¸Šä¿®ï¼Œè‚¡åƒ¹æ˜“æ¼²ã€‚", "æ˜¯è‚¡åƒ¹é ˜å…ˆæŒ‡æ¨™ã€‚"] },
    { title: "ä¸»åŠ›ä¼åœ–", icon: <Users className="w-8 h-8 text-orange-400" />, summary: "å¤§æˆ¶è²·è³£åŠ›é“ã€‚", details: ["ç´…æ£’ï¼šä¸»åŠ›ç©æ¥µè²·é€²ã€‚", "ç¶ æ£’ï¼šä¸»åŠ›èª¿ç¯€å‡ºè²¨ã€‚", "æŸ±ç‹€é«”è¶Šé•·åŠ›é“è¶Šå¼·ã€‚"] },
    { title: "å¸ƒæ—é€šé“", icon: <Layers className="w-8 h-8 text-purple-400" />, summary: "åˆ¤æ–·çªç ´èˆ‡å£“ç¸®ã€‚", details: ["çªç ´ä¸Šè»Œ+é–‹å£æ“´å¤§ï¼šæ³¢æ®µèµ·æ¼²ã€‚", "é€šé“è®Šçª„ï¼šç›¤æ•´è“„åŠ›ä¸­ã€‚", "è·Œç ´ä¸­è»Œï¼šè½‰å¼±è¨Šè™Ÿã€‚"] }
];
const FUNDAMENTAL_TERMS = [
    { title: "ROE æ’è¡Œ", sub: "è‚¡æ±æ¬Šç›Šå ±é…¬ç‡", desc: "å·´è²ç‰¹æœ€æ„›æŒ‡æ¨™ã€‚è¡¡é‡å…¬å¸æ‹¿è‚¡æ±çš„éŒ¢å»è³ºéŒ¢çš„æ•ˆç‡ã€‚æ•¸å€¼è¶Šé«˜ï¼Œä»£è¡¨å…¬å¸è¶Šæœƒæ›¿è‚¡æ±è³ºéŒ¢ã€‚", icon: <Target className="w-6 h-6 text-rose-400" /> },
    { title: "é€±è½‰ç‡æ’è¡Œ", sub: "ç¶“ç‡Ÿæ•ˆç‡æŒ‡æ¨™", desc: "æŒ‡è³‡ç”¢æˆ–å­˜è²¨çš„é€±è½‰é€Ÿåº¦ã€‚é€±è½‰ç‡è¶Šé«˜ï¼Œä»£è¡¨å…¬å¸ç”¢å“è³£å¾—è¶Šå¿«ï¼Œæˆ–è³‡ç”¢åˆ©ç”¨æ•ˆç‡è¶Šå¥½ï¼Œæ²’æœ‰å›¤è²¨å£“åŠ›ã€‚", icon: <RotateCw className="w-6 h-6 text-rose-400" /> },
    { title: "é«˜ MOM æ’è¡Œ", sub: "æœˆç‡Ÿæ”¶æˆé•·ç‡", desc: "Month On Monthã€‚åæ˜ ã€ŒçŸ­æœŸã€çš„ç‡Ÿæ”¶å‹•èƒ½ã€‚é©åˆå°‹æ‰¾å‰›é–‹å§‹è½‰å¼·ã€æ¥­ç¸¾å‡ºç¾çˆ†ç™¼æ€§æˆé•·çš„é»‘é¦¬è‚¡ã€‚", icon: <TrendingUp className="w-6 h-6 text-rose-400" /> },
    { title: "é«˜ YOY æ’è¡Œ", sub: "å¹´ç‡Ÿæ”¶æˆé•·ç‡", desc: "Year On Yearã€‚åæ˜ ã€Œé•·æœŸã€è¶¨å‹¢ä¸¦æ¶ˆé™¤æ·¡æ—ºå­£å½±éŸ¿ã€‚YOY é€£çºŒæ­£æˆé•·æ˜¯æˆé•·è‚¡çš„åŸºæœ¬æ¢ä»¶ã€‚", icon: <BarChart4 className="w-6 h-6 text-rose-400" /> },
    { title: "é«˜æ®–åˆ©ç‡æ’è¡Œ", sub: "ç¾é‡‘è‚¡åˆ©å›å ±", desc: "å­˜è‚¡æ—é¦–é¸ã€‚æ•¸å€¼è¶Šé«˜ï¼Œä»£è¡¨è‚¡åƒ¹ç›¸å°ä¾¿å®œä¸”é…æ¯å¤§æ–¹ã€‚æ˜¯ç©ºé ­å¸‚å ´æ™‚çš„æœ€ä½³é˜²ç¦¦å‹æŒ‡æ¨™ã€‚", icon: <Percent className="w-6 h-6 text-rose-400" /> },
    { title: "é«˜é…è‚¡æ’è¡Œ", sub: "è‚¡ç¥¨è‚¡åˆ©", desc: "å…¬å¸ç™¼è‚¡ç¥¨çµ¦è‚¡æ±ã€‚é€šå¸¸ä»£è¡¨å…¬å¸è™•æ–¼ã€Œæˆé•·æœŸã€ï¼Œéœ€è¦ä¿ç•™ç¾é‡‘æ“´å¼µï¼Œä¸”çœ‹å¥½æœªä¾†ç²åˆ©èƒ½ç¨€é‡‹è‚¡æœ¬ã€‚", icon: <Layers className="w-6 h-6 text-rose-400" /> },
    { title: "é«˜ EPS æ’è¡Œ", sub: "æ¯è‚¡ç›ˆé¤˜", desc: "ä¼æ¥­ç²åˆ©çš„çµ•å°æ•¸å­—ã€‚EPS è¶Šé«˜ï¼Œä»£è¡¨æ¯ä¸€è‚¡è³ºçš„éŒ¢è¶Šå¤šï¼Œæ˜¯æ”¯æ’é«˜è‚¡åƒ¹çš„æœ€åŸºç¤åœ°åŸºã€‚", icon: <DollarSign className="w-6 h-6 text-rose-400" /> },
    { title: "é«˜æ¯›åˆ©æ’è¡Œ", sub: "ç”¢å“ç«¶çˆ­åŠ›", desc: "æ¯›åˆ©ç‡ = (ç‡Ÿæ”¶-æˆæœ¬)/ç‡Ÿæ”¶ã€‚é«˜æ¯›åˆ©ä»£è¡¨ç”¢å“æœ‰ç¨ç‰¹æ€§ã€æŠ€è¡“é–€æª»é«˜ï¼Œä¸æ€•åŒæ¥­æ®ºåƒ¹ç«¶çˆ­ã€‚", icon: <Award className="w-6 h-6 text-rose-400" /> }
];
const STOCK_NAMES = {
    '0050': 'å…ƒå¤§å°ç£50', '2330': 'å°ç©é›»', '2317': 'é´»æµ·', '2454': 'è¯ç™¼ç§‘', '2382': 'å»£é”', '3231': 'ç·¯å‰µ', '3008': 'å¤§ç«‹å…‰', '2603': 'é•·æ¦®', '4991': 'ç’°å®‡-KY', '6451': 'è¨ŠèŠ¯-KY', '6706': 'æƒ ç‰¹', '6830': 'æ±éŠ“', '8111': 'ç«‹ç¢', '3234': 'å…‰ç’°', '4956': 'å…‰é‹', '3081': 'è¯äº', '3363': 'ä¸Šè©®', '3450': 'è¯éˆ', '3508': 'ä½é€Ÿ', '3576': 'è¯åˆå†ç”Ÿ', '6189': 'è±è—', '2464': 'ç›Ÿç«‹', '3615': 'å®‰å¯', '3055': 'è”šè¯ç§‘', '4960': 'èª ç¾æ', '3131': 'å¼˜å¡‘', '3583': 'è¾›è€˜', '6187': 'è¬æ½¤', '6640': 'å‡è¯', '3711': 'æ—¥æœˆå…‰æŠ•æ§', '2449': 'äº¬å…ƒé›»', '5347': 'ä¸–ç•Œå…ˆé€²', '6770': 'åŠ›ç©é›»', '2303': 'è¯é›»', '3017': 'å¥‡é‹', '3324': 'é›™é´»', '8996': 'é«˜åŠ›', '6230': 'è¶…çœ¾', '3653': 'å¥ç­–', '2009': 'ç¬¬ä¸€éŠ…', '1513': 'ä¸­èˆˆé›»', '1519': 'è¯åŸ', '1503': 'å£«é›»'
};
const STOCK_THEMES = {
    '2330': 'åŠå°é«”/æ™¶åœ“', '2454': 'åŠå°é«”/IC', '2303': 'åŠå°é«”/æ™¶åœ“', '3711': 'åŠå°é«”/å°æ¸¬', '3017': 'AI/æ•£ç†±', '3324': 'AI/æ•£ç†±', '2382': 'AI/ä¼ºæœå™¨', '2317': 'AI/ä¼ºæœå™¨'
};
const LINKS_DATA = [
    { id: 107, title: 'å°è‚¡æˆäº¤é‡æ’è¡Œ', category: 'market_info', url: 'https://www.wantgoo.com/stock/ranking/volume?market=Listed', description: 'è§€å¯Ÿå¸‚å ´ç†±éŒ¢æµå‘ã€‚æˆäº¤çˆ†é‡ä»£è¡¨å¸‚å ´é—œæ³¨åº¦é«˜ï¼Œé€šå¸¸æ³¢å‹•è¼ƒå¤§ï¼Œé©åˆçŸ­ç·šç•¶æ²–åƒè€ƒã€‚', icon: <BarChart3 className="w-6 h-6 text-rose-400" />, tag: 'ç†±éŒ¢æµå‘' },
    { id: 101, title: 'èè³‡åˆ¸å¢æ¸›è®ŠåŒ–è¡¨', category: 'market_info', url: 'https://www.peicheng.com.tw/asp/main/report/report28new.htm', description: 'å¤šç©ºé¢¨å‘çƒã€‚è³‡å¢åˆ¸å¢ä»£è¡¨è¡Œæƒ…ç†±çµ¡ï¼Œè³‡æ¸›åˆ¸å¢å¯èƒ½è»‹ç©ºï¼Œè³‡å¢åˆ¸æ¸›å‰‡éœ€å°å¿ƒä¸»åŠ›å‡ºè²¨ã€‚', icon: <ArrowLeftRight className="w-6 h-6 text-indigo-400" />, tag: 'ç±Œç¢¼è®ŠåŒ–' },
    { id: 106, title: 'ç›¤å‹¢åˆ†æ(æ—¥å ±)', category: 'market_info', url: 'https://www.peicheng.com.tw/asp/main/report/newreport.htm', description: 'æ¯æ—¥ç›¤å¾Œè§£ç›¤ã€‚æŒæ¡å¤§ç›¤å¤šç©ºæ–¹å‘ã€é—œéµæ”¯æ’å£“åŠ›èˆ‡æ˜æ—¥è§€ç›¤é‡é»ã€‚', icon: <LineChart className="w-6 h-6 text-cyan-400" />, tag: 'æ¯æ—¥å¿…è®€' },
    { id: 105, title: 'å¸‚å ´é‡è¦è¨Šæ¯ (é€±å ±)', category: 'market_info', url: 'https://www.peicheng.com.tw/wreport.htm', description: 'åŒ—åŸå®˜æ–¹è§€é»ã€‚æ¯é€±æ•´ç†çš„å¸‚å ´é‡å¤§è¨Šæ¯èˆ‡æœªä¾†ä¸€é€±è§€ç›¤é‡é»åˆ†æã€‚', icon: <Newspaper className="w-6 h-6 text-orange-400" />, tag: 'å®˜æ–¹è§€é»' },
    { id: 102, title: 'è³‡åˆ¸åˆ†é…æŸ¥è©¢', category: 'market_info', url: 'https://www.peicheng.com.tw/asp/provide/provide_list.asp', description: 'èåˆ¸æ”¾ç©ºå¿…æŸ¥ã€‚ç¢ºèªå€‹è‚¡æ˜¯å¦æœ‰è¶³å¤ çš„èåˆ¸é…é¡ï¼Œé¿å…ç©ºå–®ç„¡æ³•æˆäº¤ã€‚', icon: <Scale className="w-6 h-6 text-slate-400" />, tag: 'ç©ºå–®å¿…å‚™' },
    { id: 103, title: 'å¤šæ–¹é¸è‚¡', category: 'chips', url: 'https://www.peicheng.com.tw/asp/main/report/report_r3.html', description: 'è³‡é‡‘æµå‘å„€è¡¨æ¿ã€‚è§€å¯Ÿä¸Šå€‹æœˆå“ªäº›ç”¢æ¥­æ—ç¾¤è¡¨ç¾æœ€å¼·å‹¢ï¼Œä½œç‚ºæœ¬æœˆé¸è‚¡æ–¹å‘ã€‚', icon: <Triangle className="w-6 h-6 text-red-500 fill-red-500/20" />, tag: 'ç”¢æ¥­è¶¨å‹¢' },
    { id: 104, title: 'ç©ºæ–¹é¸è‚¡', category: 'chips', url: 'https://www.peicheng.com.tw/asp/main/report/report_r2.html', description: 'åŸºæœ¬é¢å¿«ç¯©ã€‚å¿«é€Ÿæª¢è¦–ä¸Šå€‹æœˆç‡Ÿæ”¶å¤§å¹…è¡°é€€çš„å¼±å‹¢è‚¡ï¼Œå°‹æ‰¾æ½›åœ¨åšç©ºæ©Ÿæœƒã€‚', icon: <Triangle className="w-6 h-6 text-green-500 rotate-180 fill-green-500/20" />, tag: 'ç©ºè»ä¾†è¥²' },
    { id: 1, title: 'ç±Œç¢¼é›†ä¸­åº¦æ’è¡Œ', category: 'chips', url: 'https://www.peicheng.com.tw/asp/main/report/report_r4all.html', description: 'å°‹æ‰¾ä¸»åŠ›é–ç¢¼è‚¡çš„æ ¸å¿ƒå·¥å…·ã€‚é‡é»è§€å¯Ÿ 5æ—¥ èˆ‡ 10æ—¥ é›†ä¸­åº¦æ•¸æ“šï¼Œæ•¸å€¼è¶Šé«˜ä»£è¡¨ä¸»åŠ›åƒè²¨è¶Šå…‡ã€‚', icon: <PieChart className="w-6 h-6 text-blue-400" />, tag: 'å¿…çœ‹é¦–é¸' },
    { id: 108, title: 'åˆ¸å•†åˆ†é»è²·è³£æ—¥å ±', category: 'chips', url: 'https://www.wantgoo.com/stock/major-investors/broker-buy-sell-rank', description: 'ä¸»åŠ›è¶³è·¡è¿½è¹¤ã€‚æŸ¥è©¢æ¯æ—¥ç‰¹å®šåˆ¸å•†åˆ†é»çš„è²·è³£è¶…æ˜ç´°ï¼Œæ‰¾å‡ºç¥ç¥•å¤§æˆ¶éƒ½åœ¨å“ªè£¡ä¸‹å–®ã€‚', icon: <MapPin className="w-6 h-6 text-fuchsia-400" />, tag: 'å¤§æˆ¶è¡Œè¹¤' },
    { id: 2, title: 'å¤–è³‡è²·è³£è¶…æ’è¡Œ', category: 'institutional', url: 'https://www.peicheng.com.tw/asp/main/report/dream_report/%E5%A4%96%E8%B3%87%E8%B2%B7%E8%B3%A3%E8%B6%85%E6%8E%92%E8%A1%8C.htm', description: 'è§€å¯Ÿå¤–è³‡å‹•å‘ã€‚å€åˆ†ã€Œè²·è¶…ã€èˆ‡ã€Œè³£è¶…ã€ï¼Œç•™æ„é€£çºŒ 3æ—¥ ä»¥ä¸ŠåŒå‘æ“ä½œçš„å€‹è‚¡ï¼Œæ³¢æ®µè¶¨å‹¢è¼ƒå¼·ã€‚', icon: <Briefcase className="w-6 h-6 text-emerald-400" />, tag: 'è¶¨å‹¢æŒ‡æ¨™' },
    { id: 3, title: 'æŠ•ä¿¡è²·è³£è¶…æ’è¡Œ', category: 'institutional', url: 'https://www.peicheng.com.tw/asp/main/report/dream_report/%E6%8A%95%E4%BF%A1%E8%B2%B7%E8%B3%A3%E8%B6%85%E6%8E%92%E8%A1%8C.htm', description: 'ä¸­å°å‹è‚¡çˆ†ç™¼åŠ›æŒ‡æ¨™ã€‚æŠ•ä¿¡é€£çºŒè²·è¶…é€šå¸¸æš—ç¤ºä½œå¸³è¡Œæƒ…ï¼Œé©åˆå°‹æ‰¾çŸ­ç·šé£†è‚¡ã€‚', icon: <Users className="w-6 h-6 text-orange-400" />, tag: 'ä½œå¸³è¡Œæƒ…' },
    { id: 4, title: 'è‡ªç‡Ÿå•†è²·è³£è¶…æ’è¡Œ', category: 'institutional', url: 'https://www.peicheng.com.tw/asp/main/report/dream_report/%E8%87%AA%E7%87%9F%E5%95%86%E8%B2%B7%E8%B3%A3%E8%B6%85%E6%8E%92%E8%A1%8C.htm', description: 'çŸ­ç·šé€²å‡ºåƒè€ƒã€‚è‡ªç‡Ÿå•†æ“ä½œé€šå¸¸è¼ƒçŸ­ï¼Œé©åˆæ­é…æ¬Šè­‰æˆ–æ¥µçŸ­ç·šæ“ä½œåƒè€ƒã€‚', icon: <Activity className="w-6 h-6 text-purple-400" />, tag: 'çŸ­ç·šåƒè€ƒ' },
    { id: 5, title: 'å€‹è‚¡å¤¢å¹»å ±è¡¨æŸ¥è©¢', category: 'analysis', url: 'https://www.peicheng.com.tw/asp/report/stockquery/show.asp', description: 'æœ€æ·±å…¥çš„å€‹è‚¡å¥æª¢ã€‚è¼¸å…¥ä»£ç¢¼æŸ¥çœ‹ã€Œç¶œåˆè©•åˆ†ã€ã€ã€Œä¸»åŠ›ä¼åœ–ã€èˆ‡ã€Œç±Œç¢¼å®‰å®šåº¦ã€ã€‚', icon: <Search className="w-6 h-6 text-pink-400" />, tag: 'æ·±åº¦å¥æª¢' },
    { id: 6, title: 'æ—¥å¸ƒæ—é€šé“è½‰å¼·è‚¡', category: 'tech', url: 'https://www.peicheng.com.tw/asp/main/report/BL.htm', description: 'æŠ€è¡“é¢ç¯©é¸ã€‚æ‰¾å‡ºè‚¡åƒ¹çªç ´å¸ƒæ—é€šé“ä¸Šç·£ï¼Œä¸”é–‹å£æ“´å¤§çš„è½‰å¼·å€‹è‚¡ã€‚', icon: <TrendingUp className="w-6 h-6 text-yellow-400" />, tag: 'æŠ€è¡“çªç ´' },
    { id: 109, title: 'å‡ç·šæ™ºæ…§é¸è‚¡', category: 'tech', url: 'https://goodinfo.tw/tw/StockList.asp?SHEET=%E5%9D%87%E7%B7%9A%E4%BD%8D%E7%BD%AE&MARKET_CAT=%E6%99%BA%E6%85%A7%E9%81%B8%E8%82%A1&INDUSTRY_CAT=%E6%89%80%E6%9C%89%E5%9D%87%E7%B7%9A%E5%A4%9A%E9%A0%AD%E6%8E%92%E5%88%97', description: 'ã€å¤–éƒ¨è³‡æºã€‘ä¸€éµç¯©é¸å‡ºæ‰€æœ‰å‡ç·šå‘ˆç¾ã€Œå¤šé ­æ’åˆ—ã€çš„å¼·å‹¢è‚¡ã€‚é€™æ˜¯æ³¢æ®µæ“ä½œæœ€åŸºç¤ä¹Ÿæœ€æœ‰æ•ˆçš„è¨Šè™Ÿã€‚', icon: <LineChart className="w-6 h-6 text-amber-500" />, tag: 'å¤šé ­æ’åˆ—' },
    { id: 110, title: 'TradingView è‚¡ç¥¨ç¯©é¸å™¨', category: 'tech', url: 'https://tw.tradingview.com/screener/', description: 'ã€å¤–éƒ¨è³‡æºã€‘å…¨çƒæœ€å¼·å¤§çš„åœ–è¡¨ç¯©é¸å·¥å…·ã€‚æä¾›æ•¸ç™¾ç¨®æŠ€è¡“æŒ‡æ¨™èˆ‡åŸºæœ¬é¢æ•¸æ“šï¼Œé©åˆè‡ªå®šç¾©ç­–ç•¥çš„é«˜éšç©å®¶ã€‚', icon: <SlidersHorizontal className="w-6 h-6 text-blue-500" />, tag: 'é«˜éšç¯©é¸' },
    { id: 9, title: 'Goodinfo! ç‡Ÿæ”¶å‰µæ–°é«˜æ’è¡Œ', category: 'fundamental', url: 'https://goodinfo.tw/tw/StockList.asp?SHEET=%E7%87%9F%E6%94%B6%E7%8B%80%E6%B3%81&RPT_TIME=%E6%9C%80%E6%96%B0%E8%B3%87%E6%96%99', description: 'ã€å¤–éƒ¨è³‡æºã€‘å°è‚¡è³‡æ–™åº«é¦–é¸ã€‚é€™è£¡çš„ç‡Ÿæ”¶æ•¸æ“šæ›´æ–°æœ€å¿«ï¼Œç•¶åˆ¸å•†è³‡æ–™é‚„æ²’å‡ºä¾†æ™‚ï¼Œçœ‹é€™è£¡å°±å°äº†ã€‚', icon: <Globe className="w-6 h-6 text-rose-500" />, tag: 'ğŸš€ å¤–éƒ¨è³‡æº (æœ€å¿«)' },
    { id: 7, title: 'åŸºæœ¬é¢ç¸¾æ•ˆæ’è¡Œ (EPS/ROE)', category: 'fundamental', url: 'https://www.peicheng.com.tw/asp/main/report/report_r1.html', description: 'åŒ—åŸè­‰åˆ¸å®˜æ–¹å­£å ±æ’è¡Œã€‚æ³¨æ„ï¼šè‹¥é‡è²¡å ±ç©ºçª—æœŸï¼ˆå¦‚1-3æœˆï¼‰ï¼Œå»ºè­°æ”¹çœ‹ä¸Šæ–¹çš„å¤–éƒ¨ç‡Ÿæ”¶è³‡æºã€‚', icon: <ClipboardList className="w-6 h-6 text-cyan-400" />, tag: 'å®˜æ–¹å­£å ±' }
];

// ====================================================================================
//  COMPONENTS
// ====================================================================================

const MarketSentimentGauge = () => {
    // é è¨­çš„åˆå§‹ç‹€æ…‹
    const DEFAULT_INDICATORS = [
        { name: "å°æŒ‡æœŸå¤–è³‡æ·¨æœªå¹³å€‰", value: "è¼‰å…¥ä¸­...", status: "---", color: "text-slate-400", desc: "æ­£åœ¨é€£ç·šäº¤æ˜“æ‰€æ•¸æ“š...", icon: <Briefcase className="w-5 h-5"/> },
        { name: "å¤§ç›¤é¨°è½ç·š (ADL)", value: "---", status: "---", color: "text-slate-400", desc: "æ­£åœ¨æƒæå¸‚å ´å»£åº¦...", icon: <TrendingDown className="w-5 h-5"/> },
        { name: "P/C Ratio (æˆäº¤é‡)", value: "---", status: "---", color: "text-slate-400", desc: "æ­£åœ¨è¨ˆç®—é¸æ“‡æ¬Šæ”¯æ’...", icon: <Scale className="w-5 h-5"/> },
        { name: "å°è‚¡ææ…ŒæŒ‡æ•¸ (VIX)", value: "---", status: "---", color: "text-slate-400", desc: "æ­£åœ¨è©•ä¼°å¸‚å ´é¢¨éšª...", icon: <CloudLightning className="w-5 h-5"/> },
    ];

    const [indicators, setIndicators] = useState(DEFAULT_INDICATORS);
    const [overallScore, setOverallScore] = useState(50);
    const [isLoading, setIsLoading] = useState(false);
    const [lastUpdated, setLastUpdated] = useState(null);
    const [analysisText, setAnalysisText] = useState("ç­‰å¾…æ•¸æ“šæ›´æ–°ä¸­...");
    
    // é è¨­éœæ…‹è³‡æ–™ (ä½œç‚º Placeholderï¼Œç›´åˆ° AI æ›´æ–°è¦†è“‹)
    const [sectors, setSectors] = useState([
        { name: "ç­‰å¾…æ›´æ–°...", stage: "leading", change: "---", trend: "flat", note: "é»æ“Šä¸Šæ–¹æ›´æ–°æŒ‰éˆ•" },
        { name: "ç­‰å¾…æ›´æ–°...", stage: "weakening", change: "---", trend: "flat", note: "é»æ“Šä¸Šæ–¹æ›´æ–°æŒ‰éˆ•" },
        { name: "ç­‰å¾…æ›´æ–°...", stage: "lagging", change: "---", trend: "flat", note: "é»æ“Šä¸Šæ–¹æ›´æ–°æŒ‰éˆ•" },
        { name: "ç­‰å¾…æ›´æ–°...", stage: "improving", change: "---", trend: "flat", note: "é»æ“Šä¸Šæ–¹æ›´æ–°æŒ‰éˆ•" },
    ]);

    const quadrants = {
        leading: { title: "ğŸ”¥ é ˜å…ˆ (Leading)", color: "bg-red-500/20 border-red-500/50 text-red-200", icon: <Flame className="w-4 h-4 text-red-400"/> },
        weakening: { title: "ğŸ“‰ ç²åˆ©å›å (Weakening)", color: "bg-yellow-500/20 border-yellow-500/50 text-yellow-200", icon: <TrendingDown className="w-4 h-4 text-yellow-400"/> },
        lagging: { title: "â„ï¸ è½å¾Œ (Lagging)", color: "bg-blue-500/20 border-blue-500/50 text-blue-200", icon: <CloudLightning className="w-4 h-4 text-blue-400"/> },
        improving: { title: "ğŸš€ æ”¹å–„ (Improving)", color: "bg-emerald-500/20 border-emerald-500/50 text-emerald-200", icon: <TrendingUp className="w-4 h-4 text-emerald-400"/> },
    };

    const fetchLiveSentiment = async () => {
        setIsLoading(true);
        const timeString = new Date().toLocaleString('zh-TW');
        
        // é€™æ˜¯çµ¦ AI çš„æŒ‡ä»¤ï¼Œè¦æ±‚å®ƒå» Google æœå°‹æœ€æ–°çš„çœŸå¯¦æ•¸æ“šï¼ŒåŒ…å«ã€å¤§ç›¤ç±Œç¢¼ã€‘èˆ‡ã€è³‡é‡‘è¼ªå‹•ã€‘
        const prompt = `ç¾åœ¨æ™‚é–“æ˜¯ ${timeString}ã€‚è«‹å•Ÿå‹•ã€Google Search å»£åŸŸæœå°‹æ¨¡å¼ã€‘ï¼Œæœå°‹ã€Œä»Šæ—¥ã€æˆ–ã€Œæœ€è¿‘ä¸€å€‹äº¤æ˜“æ—¥ã€çš„å°è‚¡å¤§ç›¤æ•¸æ“šèˆ‡é¡è‚¡è¡¨ç¾ã€‚
        
        ä»»å‹™ä¸€ï¼šæ‰¾å‡ºå¤§ç›¤ç±Œç¢¼æ•¸æ“š (è‹¥ä»Šæ—¥æ•¸æ“šæœªå‡ºï¼Œç”¨æ˜¨æ—¥æ”¶ç›¤)ï¼š
        1. å¤–è³‡å°æŒ‡æœŸæ·¨æœªå¹³å€‰å£æ•¸ã€‚
        2. å°è‚¡ P/C Ratioã€‚
        3. å°æŒ‡æœŸ VIX (ææ…ŒæŒ‡æ•¸)ã€‚
        4. å¸‚å ´é¨°è½ç‹€æ…‹ (æ¼²è·Œå®¶æ•¸)ã€‚

        ä»»å‹™äºŒï¼šåˆ†æä»Šæ—¥ã€è³‡é‡‘è¼ªå‹• (Sector Rotation)ã€‘ç‹€æ…‹ï¼Œå°‡é¡è‚¡æ­¸é¡è‡³ä»¥ä¸‹å››å€‹è±¡é™ (ç¸½å…±è‡³å°‘åˆ—å‡º 6-8 å€‹ä»£è¡¨æ€§æ—ç¾¤)ï¼š
        - **leading (é ˜å…ˆ)**: ä»Šæ—¥æ¼²å¹…æœ€å¼·ã€è³‡é‡‘æœ€é›†ä¸­çš„ä¸»æµæ—ç¾¤ (å¦‚ åŠå°é«”ã€AIã€èˆªé‹ ç­‰)ã€‚
        - **weakening (ç²åˆ©å›å)**: è¿‘æœŸå¼·å‹¢ä½†ä»Šæ—¥è½‰å¼±ã€é–‹é«˜èµ°ä½æˆ–æ¼²å¤šæ‹‰å›çš„æ—ç¾¤ã€‚
        - **lagging (è½å¾Œ)**: ä»Šæ—¥è·Œå¹…æœ€é‡ã€é­è³‡é‡‘ææ¬¾æˆ–æŒçºŒç ´åº•çš„å¼±å‹¢æ—ç¾¤ã€‚
        - **improving (æ”¹å–„)**: ä½æª”åå½ˆã€å‰›å‡ºé‡è½‰å¼·æˆ–æœ‰åˆ©å¤šé»ç«çš„æ—ç¾¤ã€‚

        ä¸¦è¨ˆç®—ä¸€å€‹ 0-100 çš„ã€Œå¤šç©ºç¶œåˆè©•åˆ†ã€ã€‚

        ã€æ¥µé‡è¦ï¼šè¼¸å‡ºæ ¼å¼ã€‘
        è«‹ç›´æ¥å›å‚³ä¸€å€‹æ¨™æº–çš„ JSON Objectï¼Œä¸è¦ Markdownã€‚
        **åš´æ ¼è¦ç¯„ï¼šæ‰€æœ‰æ•¸å€¼ (change, value) è«‹åªå›å‚³ã€Œæ•¸å­—%ã€æˆ–ã€Œæ•¸å€¼ã€ï¼Œçµ•å°ä¸è¦åŠ ä¸Šã€Œ(ä¼°)ã€ã€ã€Œ(est)ã€æˆ–ã€Œç´„ã€ç­‰æ¨¡ç³Šæ–‡å­—ï¼Œä¿æŒç‰ˆé¢ä¹¾æ·¨ã€‚**
        
        æ ¼å¼å¦‚ä¸‹ï¼š
        {
            "score": 45,
            "summary": "ä¸€å¥è©±ç°¡çŸ­è§£è®€ (ä¾‹å¦‚ï¼šå¤–è³‡ç©ºå–®æœªé€€ï¼Œè³‡é‡‘è¼ªå‹•è‡³å‚³ç”¢é¿éšª)",
            "indicators": [
                { "name": "å°æŒ‡æœŸå¤–è³‡æ·¨æœªå¹³å€‰", "value": "-12500 å£", "status": "åç©º", "desc": "å¤–è³‡é¿éšªæƒ…ç·’æ¿ƒåš" },
                { "name": "å¤§ç›¤é¨°è½ç·š (ADL)", "value": "æ¼²å°‘è·Œå¤š", "status": "åç©º", "desc": "ä¸­å°å‹è‚¡è³£å£“æ²‰é‡" },
                { "name": "P/C Ratio", "value": "95.2%", "status": "ä¸­æ€§", "desc": "æ”¯æ’åŠ›é“æ™®é€š" },
                { "name": "å°è‚¡ææ…ŒæŒ‡æ•¸ (VIX)", "value": "14.2", "status": "å®‰ç©©", "desc": "å¸‚å ´æƒ…ç·’å°šå±¬ç©©å®š" }
            ],
            "sectors": [
                { "name": "åŠå°é«”", "stage": "leading", "change": "+1.5%", "trend": "up", "note": "å°ç©é›»é ˜è»ä¸Šæ”»" },
                { "name": "èˆªé‹", "stage": "improving", "change": "+2.1%", "trend": "up", "note": "é‹åƒ¹åå½ˆ" },
                { "name": "å¡‘åŒ–", "stage": "lagging", "change": "-0.8%", "trend": "down", "note": "å ±åƒ¹ç–²å¼±" },
                { "name": "é‡é›»", "stage": "weakening", "change": "-1.2%", "trend": "down", "note": "æ¼²å¤šæ‹‰å›" }
            ]
        }`;

        try {
            const resultText = await callGeminiAPI(prompt, [], `ä½ æ˜¯ä¸€ä½ç²¾é€šå°è‚¡ç±Œç¢¼èˆ‡ç”¢æ¥­è¼ªå‹•çš„åˆ†æå¸«ã€‚æ™‚é–“ï¼š${timeString}ã€‚åªè¼¸å‡º JSONã€‚`, true, true);
            const data = safeParseJSON(resultText);

            if (data) {
                if (data.indicators && Array.isArray(data.indicators) && data.indicators.length >= 4) {
                    const mappedIndicators = [
                        { ...data.indicators[0], color: String(data.indicators[0]?.status || '').includes('ç©º') ? "text-green-400" : "text-red-400", icon: <Briefcase className="w-5 h-5"/> },
                        { ...data.indicators[1], color: String(data.indicators[1]?.status || '').includes('ç©º') ? "text-green-400" : "text-red-400", icon: <TrendingDown className="w-5 h-5"/> },
                        { ...data.indicators[2], color: "text-slate-300", icon: <Scale className="w-5 h-5"/> },
                        { ...data.indicators[3], color: Number(parseFloat(data.indicators[3]?.value || 0)) > 20 ? "text-red-400" : "text-green-400", icon: <CloudLightning className="w-5 h-5"/> },
                    ];
                    setIndicators(mappedIndicators);
                }
                
                if (data.sectors && Array.isArray(data.sectors)) {
                    setSectors(data.sectors);
                }

                setOverallScore(data.score || 50);
                setAnalysisText(data.summary || "æ•¸æ“šæ›´æ–°å®Œæˆ");
                setLastUpdated(new Date());
            }
        } catch (e) {
            console.error("Sentiment fetch failed:", e);
            setAnalysisText("æ•¸æ“šæ›´æ–°å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
        } finally {
            setIsLoading(false);
        }
    };

    // é¦–æ¬¡è¼‰å…¥æ™‚è‡ªå‹•æ›´æ–°ä¸€æ¬¡
    useEffect(() => {
        fetchLiveSentiment(); 
    }, []);

    return (
        <div className="animate-fadeIn space-y-6">
            {/* ä¸ŠåŠéƒ¨ï¼šå¤§ç›¤æº«åº¦è¨ˆ */}
            <div className="bg-slate-900 border border-slate-700/50 rounded-2xl p-6 shadow-2xl relative overflow-hidden">
                <div className="absolute top-0 right-0 w-64 h-64 bg-emerald-900/10 rounded-full blur-3xl -translate-y-1/2 translate-x-1/3 pointer-events-none"></div>
                <div className="flex flex-col md:flex-row items-center justify-between gap-6 relative z-10">
                    <div className="flex-1 w-full">
                        <div className="flex items-center justify-between mb-4">
                            <div className="flex items-center gap-3">
                                <div className="p-2 bg-gradient-to-r from-emerald-600 to-teal-600 rounded-lg shadow-lg"><ThermometerSun className="w-6 h-6 text-white" /></div>
                                <div>
                                    <h2 className="text-2xl font-bold text-white tracking-wide">å¤§ç›¤å¤šç©ºæº«åº¦è¨ˆ</h2>
                                    <p className="text-slate-400 text-xs flex items-center gap-2">
                                        {lastUpdated ? `æ›´æ–°æ–¼: ${lastUpdated.toLocaleTimeString()}` : "æ­£åœ¨åˆå§‹åŒ–æ•¸æ“š..."}
                                        {isLoading && <span className="text-emerald-400 animate-pulse">â— é€£ç·šäº¤æ˜“æ‰€ä¸­...</span>}
                                    </p>
                                </div>
                            </div>
                            <button 
                                onClick={fetchLiveSentiment} 
                                disabled={isLoading}
                                className={`px-4 py-2 rounded-lg text-xs font-bold flex items-center gap-2 transition-all ${isLoading ? 'bg-slate-800 text-slate-500 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-500 text-white shadow-lg shadow-blue-500/30'}`}
                            >
                                <RefreshCw className={`w-3.5 h-3.5 ${isLoading ? 'animate-spin' : ''}`} />
                                {isLoading ? "æƒæä¸­..." : "æ›´æ–°å³æ™‚æ•¸æ“š"}
                            </button>
                        </div>
                        
                        <div className="mb-4 bg-slate-800/40 p-3 rounded-lg border border-slate-700/50">
                            <span className="text-xs text-slate-400 font-bold mr-2">AI æˆ°æƒ…è§£è®€ï¼š</span>
                            <span className="text-sm text-slate-200">{analysisText}</span>
                        </div>

                        <div className="space-y-3">
                            {indicators.map((ind, idx) => (
                                <div key={idx} className="bg-slate-800/50 border border-slate-700/50 rounded-lg p-3 flex items-center justify-between hover:bg-slate-800 transition-colors">
                                    <div className="flex items-center gap-3"><div className="text-slate-500">{ind.icon}</div><div><div className="text-sm font-bold text-slate-200">{ind.name}</div><div className="text-[10px] text-slate-500">{ind.desc}</div></div></div>
                                    <div className="text-right"><div className={`text-sm font-mono font-bold ${ind.color}`}>{ind.value}</div><div className="text-[10px] px-1.5 py-0.5 rounded bg-slate-900 border border-slate-700 inline-block mt-1">{ind.status}</div></div>
                                </div>
                            ))}
                        </div>
                    </div>
                    <div className="w-full md:w-1/3 flex flex-col items-center justify-center bg-slate-800/30 rounded-xl p-6 border border-slate-700/50">
                        <h3 className="text-slate-400 text-sm mb-4 font-bold">ç›®å‰å¸‚å ´æƒ…ç·’</h3>
                        <div className="relative w-48 h-24 overflow-hidden mb-4">
                            <div className="absolute top-0 left-0 w-full h-full bg-slate-700 rounded-t-full"></div>
                            <div className="absolute top-2 left-2 w-[calc(100%-16px)] h-[calc(100%-16px)] bg-slate-900 rounded-t-full z-10"></div>
                            <div className="absolute top-0 left-0 w-full h-full rounded-t-full z-0 thermometer-gradient opacity-80" style={{ clipPath: 'polygon(0 100%, 100% 100%, 100% 0, 0 0)' }}></div>
                            <div className="absolute bottom-0 left-1/2 w-1 h-full bg-white origin-bottom z-20 transition-transform duration-1000 ease-out" style={{ transform: `translateX(-50%) rotate(${(overallScore / 100) * 180 - 90}deg)` }}></div>
                            <div className="absolute bottom-0 left-1/2 w-4 h-4 bg-white rounded-full -translate-x-1/2 translate-y-1/2 z-30 shadow-lg"></div>
                        </div>
                        <div className="text-center"><div className={`text-3xl font-bold ${overallScore > 60 ? 'text-red-400' : overallScore < 40 ? 'text-green-400' : 'text-yellow-400'}`}>{overallScore > 60 ? 'éç†±' : overallScore < 40 ? 'ä¿å®ˆ' : 'ä¸­æ€§åç©º'}</div><p className="text-xs text-slate-500 mt-1">ç¶œåˆè©•åˆ†: {overallScore}/100</p></div>
                    </div>
                </div>
            </div>

            {/* ä¸‹åŠéƒ¨ï¼šè³‡é‡‘è¼ªå‹•é€±æœŸè¡¨ (Sector Rotation) - å‡ç´šç‚º AI è¯ç¶²ç‰ˆ */}
            <div className="bg-slate-900 border border-slate-700/50 rounded-2xl p-6 shadow-xl">
                <div className="flex items-center gap-3 mb-6">
                    <div className="p-2 bg-indigo-600 rounded-lg shadow-lg"><RefreshCw className="w-6 h-6 text-white" /></div>
                    <div>
                        <h2 className="text-2xl font-bold text-white tracking-wide">è³‡é‡‘è¼ªå‹•é€±æœŸè¡¨ (Sector Rotation)</h2>
                        <p className="text-slate-400 text-xs">AI è‡ªå‹•æƒæä»Šæ—¥æ¼²è·Œæ¿å¡Šï¼Œæ•æ‰å¸‚å ´ä¸»æµ</p>
                    </div>
                </div>
                
                {isLoading ? (
                     <div className="py-20 text-center border border-slate-800 rounded-xl bg-slate-800/30">
                        <Loader2 className="w-10 h-10 text-indigo-500 animate-spin mx-auto mb-4" />
                        <p className="text-slate-400 text-sm">AI æ­£åœ¨æƒæå…¨å¸‚å ´é¡è‚¡æ¼²è·Œ...</p>
                     </div>
                ) : (
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {['leading', 'weakening', 'improving', 'lagging'].map(stage => (
                            <div key={stage} className={`sector-quadrant rounded-xl border p-4 ${quadrants[stage].color}`}>
                                <div className="flex items-center gap-2 mb-3 pb-2 border-b border-white/10">
                                    {quadrants[stage].icon}
                                    <h3 className="font-bold text-sm tracking-wide">{quadrants[stage].title}</h3>
                                </div>
                                <div className="space-y-2">
                                    {sectors.filter(s => s.stage === stage).map((sector, sIdx) => (
                                        <div key={sIdx} className="bg-slate-900/60 rounded-lg p-2 flex justify-between items-center hover:bg-slate-900/80 transition-colors">
                                            <div>
                                                <div className="text-sm font-bold text-white flex items-center gap-1">
                                                    {sector.name}
                                                </div>
                                                <div className="text-[10px] text-slate-400">{sector.note}</div>
                                            </div>
                                            <div className="text-right">
                                                <span className={`text-xs font-mono font-bold ${String(sector.change || '').includes('-') || String(sector.change || '').includes('â–¼') ? 'text-green-400' : 'text-red-400'}`}>{sector.change}</span>
                                            </div>
                                        </div>
                                    ))}
                                    {sectors.filter(s => s.stage === stage).length === 0 && <div className="text-center text-xs text-white/40 py-2">- æ­¤è±¡é™æš«ç„¡æ—ç¾¤ -</div>}
                                </div>
                            </div>
                        ))}
                    </div>
                )}
                
                {/* é€±æœŸèªªæ˜åœ–ç¤º */}
                <div className="mt-6 flex flex-wrap justify-center gap-4 text-[10px] text-slate-500 bg-slate-800/30 p-3 rounded-xl border border-slate-700/30">
                    <div className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-emerald-500"></span> æ”¹å–„ (Improving): è³‡é‡‘é–‹å§‹é€²é§ï¼Œåº•éƒ¨è½‰å¼·</div>
                    <div className="flex items-center gap-1"><MoveRight className="w-3 h-3 text-slate-600"/></div>
                    <div className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-red-500"></span> é ˜å…ˆ (Leading): ä¸»æµå¼·å‹¢è‚¡ï¼Œå‹•èƒ½æœ€å¼·</div>
                    <div className="flex items-center gap-1"><MoveRight className="w-3 h-3 text-slate-600"/></div>
                    <div className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-yellow-500"></span> ç²åˆ©å›å (Weakening): å‹•èƒ½æ¸›å¼±ï¼Œéœ€å°å¿ƒ</div>
                    <div className="flex items-center gap-1"><MoveRight className="w-3 h-3 text-slate-600"/></div>
                    <div className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-blue-500"></span> è½å¾Œ (Lagging): è³‡é‡‘æ’¤é›¢ï¼Œç›¸å°å¼±å‹¢</div>
                </div>
            </div>
        </div>
    );
};

const TradingViewTicker = () => {
    const containerRef = useRef(null);
    useEffect(() => {
        let container = containerRef.current;
        if (container) {
            container.innerHTML = ''; 
            const script = document.createElement('script');
            script.src = 'https://s3.tradingview.com/external-embedding/embed-widget-ticker-tape.js';
            script.async = true;
            script.innerHTML = JSON.stringify({
                "symbols": [
                    { "proName": "AMEX:SPY", "title": "æ¨™æ™®500" }, { "proName": "NASDAQ:QQQ", "title": "é‚£æ–¯é”å…‹" },
                    { "proName": "NASDAQ:SOXX", "title": "è²»åŠETF" }, { "proName": "AMEX:EWT", "title": "å°è‚¡ETF" },
                    { "proName": "AMEX:UUP", "title": "ç¾å…ƒETF" }, { "proName": "BATS:VXX", "title": "ææ…ŒETF" },
                    { "proName": "NASDAQ:TLT", "title": "ç¾å‚µ20å¹´" }, { "proName": "COINBASE:BTCUSD", "title": "æ¯”ç‰¹å¹£" }
                ],
                "showSymbolLogo": true, "colorTheme": "dark", "isTransparent": false, "displayMode": "adaptive", "locale": "zh_TW"
            });
            container.appendChild(script);
        }
        return () => { if(container) container.innerHTML = ''; }
    }, []);
    return <div className="w-full bg-[#131722] border-b border-slate-700 shadow-xl relative z-10"><div className="tradingview-widget-container" ref={containerRef}><div className="tradingview-widget-container__widget"></div></div></div>;
};

const MarketClock = () => {
    const [time, setTime] = useState(new Date());
    const [status, setStatus] = useState({ label: 'ä¼‘å¸‚ä¸­', color: 'text-slate-500', dot: 'bg-slate-600' });
    useEffect(() => {
        const timer = setInterval(() => {
            const now = new Date();
            setTime(now);
            const day = now.getDay();
            const h = now.getHours();
            const m = now.getMinutes();
            const totalMinutes = h * 60 + m;
            if (day === 0 || day === 6) { setStatus({ label: 'é€±æœ«ä¼‘å¸‚', color: 'text-slate-500', dot: 'bg-slate-600' }); return; }
            if (totalMinutes >= 510 && totalMinutes < 540) { setStatus({ label: 'ç›¤å‰è©¦æ’®', color: 'text-yellow-400', dot: 'bg-yellow-500 animate-pulse' }); }
            else if (totalMinutes >= 540 && totalMinutes < 810) { setStatus({ label: 'ç›¤ä¸­äº¤æ˜“', color: 'text-emerald-400', dot: 'bg-emerald-500 animate-pulse' }); }
            else if (totalMinutes >= 810 && totalMinutes < 870) { setStatus({ label: 'ç›¤å¾Œå®šåƒ¹', color: 'text-blue-400', dot: 'bg-blue-500' }); }
            else { setStatus({ label: 'å·²æ”¶ç›¤', color: 'text-slate-500', dot: 'bg-slate-600' }); }
        }, 1000);
        return () => clearInterval(timer);
    }, []);
    return (
        <div className="flex flex-col items-end animate-fadeIn">
            <div className="flex items-center gap-2 mb-1"><span className={`w-2 h-2 rounded-full ${status.dot}`}></span><span className={`text-xs font-bold ${status.color}`}>{status.label}</span></div>
            <div className="flex items-center gap-2 bg-slate-800/80 px-4 py-2 rounded-lg border border-slate-700/50 shadow-inner backdrop-blur-sm">
                <Clock className="w-5 h-5 text-slate-400" /><span className="text-2xl font-mono font-bold text-white tracking-widest leading-none">{time.toLocaleTimeString('zh-TW', { hour12: false })}</span>
            </div>
            <span className="text-[10px] text-slate-500 font-mono mt-1 tracking-wider uppercase">{time.toLocaleDateString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit' })}</span>
        </div>
    );
};

const ChartLauncher = ({ symbol, onClose }) => {
    const openPopup = (url, title) => {
        const width = 1200; const height = 800;
        const left = (window.screen.width - width) / 2; const top = (window.screen.height - height) / 2;
        window.open(url, title, `toolbar=no,location=no,status=no,menubar=no,scrollbars=yes,resizable=yes,width=${width},height=${height},top=${top},left=${left}`);
    };
    const charts = [
        { name: 'HiStock å—¨æŠ•è³‡', desc: 'æœ€å¼·Kç·šåˆ†æ', url: `https://histock.tw/stock/tv/tvchart.aspx?no=${symbol}`, color: 'bg-gradient-to-br from-[#451a03] via-[#78350f] to-[#92400e] hover:from-[#78350f] hover:to-[#b45309]', textColor: 'text-amber-100', icon: <CandlestickChart className="w-6 h-6 text-amber-400" />, border: 'border-amber-500/40 group-hover:border-amber-400/80 shadow-[0_0_15px_rgba(245,158,11,0.15)]' },
        { name: 'ç©è‚¡ç¶²', desc: 'å°è‚¡æŠ€è¡“åˆ†æé¦–é¸', url: `https://www.wantgoo.com/stock/${symbol}/technical-chart`, color: 'bg-gradient-to-br from-[#4c0519] via-[#881337] to-[#9f1239] hover:from-[#881337] hover:to-[#e11d48]', textColor: 'text-rose-100', icon: <LineChart className="w-6 h-6 text-rose-400" />, border: 'border-rose-500/40 group-hover:border-rose-400/80 shadow-[0_0_15px_rgba(244,63,94,0.15)]' },
        { name: 'Yahoo è‚¡å¸‚', desc: 'å³æ™‚å ±åƒ¹èˆ‡äº”æª”', url: `https://tw.stock.yahoo.com/quote/${symbol}/technical-analysis`, color: 'bg-gradient-to-br from-[#2e1065] via-[#581c87] to-[#7e22ce] hover:from-[#581c87] hover:to-[#a855f7]', textColor: 'text-purple-100', icon: <Activity className="w-6 h-6 text-purple-400" />, border: 'border-purple-500/40 group-hover:border-purple-400/80 shadow-[0_0_15px_rgba(168,85,247,0.15)]' }
    ];
    return (
        <div className="mb-10 w-full max-w-4xl mx-auto animate-fadeIn relative z-20">
            <div className="bg-slate-900/95 backdrop-blur-md border border-slate-700/50 rounded-3xl overflow-hidden shadow-2xl relative p-6 md:p-8 ring-1 ring-white/10">
                <button onClick={onClose} className="absolute top-4 right-4 z-10 p-2 bg-slate-800/80 hover:bg-slate-700 rounded-full text-slate-400 hover:text-white transition-colors border border-slate-600/50" title="é—œé–‰"><XCircle className="w-5 h-5" /></button>
                <div className="text-center mb-6"><h2 className="text-2xl font-bold text-white mb-2 flex items-center justify-center gap-3"><span className="text-3xl text-yellow-400 font-mono tracking-widest">{symbol}</span><span className="text-slate-200">å®Œæ•´æŠ€è¡“åˆ†æ</span></h2></div>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">{charts.map((chart) => (<button key={chart.name} onClick={() => openPopup(chart.url, chart.name)} className={`dashboard-card relative group p-4 rounded-2xl border ${chart.border} ${chart.color} flex flex-col items-center justify-center gap-2 h-36 hover:scale-[1.03] transition-all duration-300`}><div className="p-3 bg-black/40 rounded-xl shadow-inner mb-1 border border-white/5">{chart.icon}</div><div className="text-center"><h3 className={`text-lg font-bold ${chart.textColor}`}>{chart.name}</h3><p className="text-white/60 text-xs font-medium">{chart.desc}</p></div></button>))}</div>
                <div className="flex justify-center border-t border-slate-800/50 pt-6"><button onClick={() => window.open(`https://www.peicheng.com.tw/asp/stockquery/${symbol}.htm`, '_blank')} className="btn-neon-breathing relative overflow-hidden group text-white px-12 py-5 rounded-xl text-lg font-bold flex items-center gap-5 transition-all hover:scale-[1.02] shadow-2xl border border-rose-500/30"><div className="absolute inset-0 bg-gradient-to-r from-white/0 via-white/20 to-white/0 translate-x-[-100%] group-hover:translate-x-[100%] transition-transform duration-1000 pointer-events-none"></div><Search className="w-6 h-6 text-white animate-pulse" /><div className="flex flex-col items-center leading-none gap-1.5"><span className="tracking-wide text-white drop-shadow-sm text-xl">æŸ¥çœ‹ {symbol} å¤¢å¹»å ±è¡¨</span><span className="text-[11px] text-white/90 font-medium tracking-[0.2em] uppercase text-shadow-sm">â˜… ç¶œåˆè©•åˆ† / æ·±åº¦æª¢æ¸¬ â˜…</span></div></button></div>
            </div>
        </div>
    );
};

const AlphaHunterPro = ({ openChart }) => {
    const [selectedThemeId, setSelectedThemeId] = useState('ai_server'); 
    const [newsToVerify, setNewsToVerify] = useState("");
    const [verificationResult, setVerificationResult] = useState(null);
    const [isVerifying, setIsVerifying] = useState(false);
    const [verifyImages, setVerifyImages] = useState([]); 
    const [isVerifyDragging, setIsVerifyDragging] = useState(false);
    const verifyFileRef = useRef(null);
    const [newsFeed, setNewsFeed] = useState(GLOBAL_NEWS_CACHE.data || STATIC_NEWS_FALLBACK);
    const [isNewsLoading, setIsNewsLoading] = useState(false);
    const [generationError, setGenerationError] = useState(null);
    const [themeDatabase, setThemeDatabase] = useState(INITIAL_THEME_DATABASE);
    const [isGeneratingTheme, setIsGeneratingTheme] = useState(false);
    const isHoveringRef = useRef(false);
    const activeTheme = themeDatabase[selectedThemeId];

    const fetchLatestNews = useCallback(async (forceRefresh = false) => {
        const now = Date.now();
        if (!forceRefresh && GLOBAL_NEWS_CACHE.data && (now - GLOBAL_NEWS_CACHE.timestamp < GLOBAL_NEWS_CACHE.CACHE_DURATION)) {
            setNewsFeed(GLOBAL_NEWS_CACHE.data);
            return;
        }
        setIsNewsLoading(true);
        const timeString = new Date().toLocaleString('zh-TW');
        const prompt = `ç¾åœ¨æ™‚é–“æ˜¯ ${timeString}ã€‚è«‹å•Ÿå‹•ã€å»£åŸŸæœå°‹æ¨¡å¼ã€‘ï¼Œå‹™å¿…ä½¿ç”¨ Google Search æ‰¾å‡ºã€Œä»Šæ—¥ã€(${timeString.split(' ')[0]}) å°ç£è‚¡å¸‚æœ€æ–°ã€è¨è«–åº¦æœ€é«˜ã€æˆäº¤å‹•èƒ½æœ€å¼·çš„ 6 å‰‡ç†±é–€é¡Œææ–°èã€‚
        ã€é‡è¦è¦å‰‡ã€‘
        1. **èªè¨€é™åˆ¶**ï¼šæ¨™é¡Œ (title) å¿…é ˆå®Œå…¨ä½¿ç”¨ã€Œç¹é«”ä¸­æ–‡ã€ã€‚**åš´ç¦**å‡ºç¾è‹±æ–‡ç¿»è­¯æˆ–ä¸­è‹±å°ç…§æ ¼å¼ã€‚è‹¥åŸæ–‡æ˜¯è‹±æ–‡ï¼Œè«‹ç¿»è­¯æˆæµæš¢çš„å°ç£è²¡ç¶“è¡“èªã€‚
        2. **æ™‚æ•ˆæ€§**ï¼šå¿…é ˆæ˜¯ã€Œæ­£åœ¨ç™¼ç”Ÿã€çš„äº‹æƒ…ï¼Œåš´ç¦ä½¿ç”¨éæ™‚è³‡æ–™ã€‚
        3. **æ ¼å¼**ï¼šè«‹åªå›å‚³ä¸€å€‹æ¨™æº–çš„ JSON Arrayï¼Œä¸è¦åŒ…å« markdown æ¨™è¨˜ (\`\`\`json) æˆ–å…¶ä»–æ–‡å­—ã€‚
        4. **æ•¸é‡**ï¼šè«‹å›å‚³ 6 ç­†è³‡æ–™ã€‚
        æ ¼å¼å¦‚ä¸‹ï¼š
        [ { "id": 1, "title": "æ–°èæ¨™é¡Œ", "tag": "theme_tag", "time": "æ™‚é–“", "reliability": "high", "source": "ä¾†æº" } ]`;
        try {
            const resultText = await callGeminiAPI(prompt, [], `åš´æ ¼ JSON ç”Ÿæˆå™¨ã€‚æ™‚é–“ï¼š${timeString}ã€‚åƒ…è¼¸å‡º JSONã€‚`, true, true);
            const newsData = safeParseJSON(resultText);
            
            // Auto-fix: è‡ªå‹•æœå°‹ä¸¦æå– JSON ä¸­çš„ä»»ä½•é™£åˆ—
            let finalResults = [];
            if (Array.isArray(newsData)) {
                finalResults = newsData;
            } else if (newsData && typeof newsData === 'object') {
                for (const key in newsData) {
                    if (Array.isArray(newsData[key])) {
                        finalResults = newsData[key];
                        break;
                    }
                }
            }

            if (finalResults.length > 0) {
                const safeNewsData = finalResults.map(item => ({ id: item.id || Math.random(), title: String(item.title || "æœªçŸ¥æ¨™é¡Œ"), tag: String(item.tag || "hot_topic_" + Math.random()), time: String(item.time || "å‰›å‰›"), reliability: String(item.reliability || "medium"), source: String(item.source || "Google Search") }));
                GLOBAL_NEWS_CACHE.data = safeNewsData; GLOBAL_NEWS_CACHE.timestamp = Date.now(); setNewsFeed(safeNewsData);
            }
        } catch (e) { console.error("News fetch failed:", e); if (GLOBAL_NEWS_CACHE.data) setNewsFeed(GLOBAL_NEWS_CACHE.data); } finally { setIsNewsLoading(false); }
    }, []);
    useEffect(() => { fetchLatestNews(false); }, [fetchLatestNews]);

    const handleNewsClick = async (tag, title) => {
        setGenerationError(null);
        if (themeDatabase[tag]) { setSelectedThemeId(tag); return; }
        setIsGeneratingTheme(true); setSelectedThemeId(tag); 
        const now = new Date();
        const timeString = now.toLocaleString('zh-TW');
        const prompt = `è«‹é‡å°å°è‚¡é¡Œæã€${title} (Tag: ${tag})ã€‘é€²è¡Œæ·±åº¦å³æ™‚ä¾›æ‡‰éˆåˆ†æã€‚ç¾åœ¨æ™‚é–“ï¼š${timeString}ã€‚ä»»å‹™ï¼šæ‰¾å‡ºè©²é¡Œæã€Œä»Šæ—¥ã€æœ€å¼·å‹¢çš„ã€Œä¸Šæ¸¸ã€ä¸­æ¸¸ã€ä¸‹æ¸¸ã€å—æƒ å°è‚¡ï¼Œåš´æ ¼æŸ¥åƒ¹ã€‚
        
        ã€æ¥µé‡è¦ï¼šè¼¸å‡ºæ ¼å¼ã€‘
        è«‹ç›´æ¥å›å‚³ä¸€å€‹æ¨™æº–çš„ JSON Objectï¼Œä¸è¦åŒ…å«ä»»ä½•é–‹å ´ç™½æˆ–çµå°¾èªï¼ˆå¦‚ã€Œå¥½çš„ï¼Œé€™æ˜¯åˆ†æ...ã€ï¼‰ã€‚
        æ ¼å¼ç¯„ä¾‹ï¼š
        {
            "id": "theme_tag",
            "name": "é¡Œæåç¨±",
            "desc": "ç°¡è¿°",
            "hypeScore": 88,
            "stage": "ä¸»å‡æ®µ",
            "catalyst": "å‚¬åŒ–åŠ‘",
            "segmentAnalysis": {
                "upstream": { "heat": 90, "status": "ğŸ”¥ ç¼ºè²¨", "desc": "èªªæ˜", "stocks": [{"code": "2330", "name": "å°ç©é›»", "role": "æ™¶åœ“", "isLeader": true, "flow": "å¤–è³‡", "note": "å‚™è¨»"}] },
                "midstream": { "heat": 80, "status": "ğŸ“ˆ å¼·å‹¢", "desc": "èªªæ˜", "stocks": [] },
                "downstream": { "heat": 70, "status": "âš¡ çˆ†ç™¼", "desc": "èªªæ˜", "stocks": [] }
            }
        }`;
        try {
            const resultText = await callGeminiAPI(prompt, [], `å³æ™‚è‚¡å¸‚æ•¸æ“šåº«ã€‚æ™‚é–“ï¼š${timeString}ã€‚åªè¼¸å‡º JSONï¼Œä¸è¦ Markdownã€‚`, true, true);
            const newThemeData = safeParseJSON(resultText);
            if (newThemeData && newThemeData.segmentAnalysis) { setThemeDatabase(prev => ({ ...prev, [tag]: newThemeData })); }
        } catch (e) { console.error("Theme gen failed:", e); setGenerationError("AI åˆ†æç”Ÿæˆå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚"); } finally { setIsGeneratingTheme(false); }
    };

    const processVerifyFiles = (files) => { Array.from(files).forEach(file => { if (file.type.startsWith('image/')) { const reader = new FileReader(); reader.onloadend = () => { setVerifyImages(prev => [...prev, reader.result]); }; reader.readAsDataURL(file); } }); };
    const handleVerifyImageSelect = (e) => { processVerifyFiles(e.target.files); };
    const removeVerifyImage = (index) => { setVerifyImages(prev => prev.filter((_, i) => i !== index)); };
    const handleVerifyDragOver = (e) => { e.preventDefault(); setIsVerifyDragging(true); };
    const handleVerifyDragLeave = (e) => { e.preventDefault(); setIsVerifyDragging(false); };
    const handleVerifyDrop = (e) => { e.preventDefault(); setIsVerifyDragging(false); processFiles(e.dataTransfer.files); };
    useEffect(() => { const handlePaste = (e) => { if (!isHoveringRef.current) return; if (!e.clipboardData || !e.clipboardData.items) return; const items = e.clipboardData.items; for (let i = 0; i < items.length; i++) { if (items[i].type.indexOf('image') !== -1) { const blob = items[i].getAsFile(); const reader = new FileReader(); reader.onloadend = () => { setVerifyImages(prev => [...prev, reader.result]); }; reader.readAsDataURL(blob); e.preventDefault(); } } }; window.addEventListener('paste', handlePaste); return () => { window.removeEventListener('paste', handlePaste); }; }, []);
    const handleVerifyNews = async () => { if (!newsToVerify.trim() && verifyImages.length === 0) return; setIsVerifying(true); setVerificationResult(null); const prompt = `é©—è­‰çœŸå¯¦æ€§ï¼š${newsToVerify}`; try { const result = await callGeminiAPI(prompt, verifyImages, "åš´æ ¼æŸ¥æ ¸å“¡", true, false); setVerificationResult(typeof result === 'string' ? result : JSON.stringify(result)); } catch(e) { setVerificationResult("æŸ¥æ ¸å¤±æ•—"); } finally { setIsVerifying(false); } };

    const renderHeatBar = (heat) => ( <div className="flex items-center gap-2"><div className="flex-1 h-2 bg-slate-700 rounded-full overflow-hidden"><div className={`h-full rounded-full transition-all duration-1000 ${heat > 80 ? 'bg-gradient-to-r from-red-500 to-orange-500' : heat > 50 ? 'bg-gradient-to-r from-yellow-500 to-orange-400' : 'bg-blue-500'}`} style={{ width: `${heat}%` }}></div></div><span className={`text-xs font-mono font-bold ${heat > 80 ? 'text-red-400' : 'text-slate-400'}`}>{heat}</span></div> );

    const SegmentCard = ({ title, data }) => {
        if (!data || !data.stocks) return (<div className="flex-1 min-w-[300px] bg-slate-800/40 rounded-xl border border-slate-700/50 p-4 flex flex-col items-center justify-center text-slate-500 text-xs"><Loader2 className="w-6 h-6 animate-spin mb-2 opacity-50" />åˆ†ææ•¸æ“šè¼‰å…¥ä¸­...</div>);
        return (
            <div className={`flex-1 min-w-[300px] bg-slate-800/40 rounded-xl border backdrop-blur-sm transition-all group hover:bg-slate-800/60 ${data.heat > 80 ? 'border-red-500/30 shadow-[0_0_15px_rgba(239,68,68,0.1)]' : 'border-slate-700/50'}`}>
                <div className="p-4 border-b border-slate-700/50 flex justify-between items-center"><div><h4 className="font-bold text-slate-200 flex items-center gap-2">{title}{data.heat > 80 && <Flame className="w-4 h-4 text-red-500 animate-pulse" />}</h4><span className={`text-[10px] px-1.5 py-0.5 rounded border ${data.heat > 80 ? 'text-red-400 border-red-500/30 bg-red-900/20' : 'text-slate-400 border-slate-600 bg-slate-800'}`}>{String(data.status)}</span></div><div className="text-right"><div className="text-[10px] text-slate-500 mb-1">è³‡é‡‘ç†±åº¦</div>{renderHeatBar(data.heat)}</div></div>
                <div className="p-4 space-y-3"><p className="text-xs text-slate-400 italic mb-3">{String(data.desc)}</p>{data.stocks.map((stock) => (<div key={stock.code} onClick={() => openChart(stock.code)} className={`relative p-3 rounded-lg border cursor-pointer transition-all hover:-translate-y-0.5 ${stock.isLeader ? 'bg-gradient-to-r from-indigo-900/40 to-slate-900 border-indigo-500/50 hover:border-indigo-400' : 'bg-slate-900/50 border-slate-700/50 hover:border-slate-500'}`}>{stock.isLeader && (<div className="absolute -top-2 -right-2 bg-yellow-500 text-black text-[9px] font-bold px-1.5 py-0.5 rounded-full shadow-lg border border-yellow-300 flex items-center gap-0.5"><Trophy className="w-2.5 h-2.5" /> é ˜é ­ç¾Š</div>)}<div className="flex justify-between items-start mb-1"><div className="flex items-center gap-2"><span className="font-mono font-bold text-white text-base">{String(stock.code)}</span><span className="text-sm text-slate-300 font-bold">{String(stock.name)}</span></div><span className={`text-[9px] px-1.5 py-0.5 rounded ${String(stock.flow || '').includes('ä¸»åŠ›') ? 'bg-red-900/30 text-red-400' : 'bg-slate-800 text-slate-500'}`}>{String(stock.flow)}</span></div><div className="flex justify-between items-end"><span className="text-[10px] text-slate-500 bg-slate-800/80 px-1 rounded">{String(stock.role)}</span><span className="text-[10px] text-indigo-300">{String(stock.note)}</span></div></div>))}</div>
            </div>
        );
    };

    return (
        <div className="animate-fadeIn space-y-6">
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div className="lg:col-span-2 bg-slate-800/80 border border-slate-700 rounded-2xl p-5 relative overflow-hidden">
                    <div className="flex items-center justify-between mb-4"><div className="flex items-center gap-2"><Megaphone className="w-5 h-5 text-yellow-400" /><h3 className="font-bold text-white">å¸‚å ´å‚³èå¿«ç¯© (Live)</h3>{isNewsLoading && <span className="text-xs text-emerald-400 animate-pulse flex items-center gap-1"><Globe className="w-3 h-3" /> å»£åŸŸæœç´¢ä¸­...</span>}</div><button onClick={() => fetchLatestNews(true)} className="text-xs bg-slate-700 hover:bg-slate-600 px-2 py-1 rounded text-slate-300 flex items-center gap-1 transition-colors"><RefreshCw className={`w-3 h-3 ${isNewsLoading ? 'animate-spin' : ''}`} /> åˆ·æ–°</button></div>
                    <div className="space-y-3">{newsFeed.map(news => (<button key={news.id} onClick={() => handleNewsClick(news.tag, news.title)} className={`w-full text-left p-3 rounded-xl border transition-all group hover:bg-slate-700/50 ${selectedThemeId === news.tag ? 'bg-indigo-900/30 border-indigo-500 shadow-[0_0_10px_rgba(99,102,241,0.2)]' : 'bg-slate-900/40 border-slate-700/50'}`}><div className="flex justify-between items-start mb-1"><div className="flex items-center gap-2"><span className={`text-[9px] px-1.5 py-0.5 rounded border ${news.reliability === 'high' ? 'text-emerald-400 border-emerald-500/30' : 'text-yellow-400 border-yellow-500/30'}`}>{news.reliability === 'high' ? 'å¯ä¿¡åº¦é«˜' : 'è§€å¯Ÿä¸­'}</span><span className="text-[10px] text-slate-500">{String(news.source)}</span></div><span className="text-[10px] text-slate-500 flex items-center gap-1"><Clock className="w-3 h-3" /> {String(news.time)}</span></div><h4 className={`text-sm font-bold leading-snug group-hover:text-white ${selectedThemeId === news.tag ? 'text-indigo-300' : 'text-slate-300'}`}>{String(news.title)}</h4></button>))}</div>
                </div>
                <div className={`lg:col-span-1 bg-gradient-to-br from-slate-900 to-indigo-950 border rounded-2xl p-5 flex flex-col relative transition-all duration-300 ${isVerifyDragging ? 'border-emerald-500 scale-[1.01]' : 'border-indigo-500/30'}`} onDragOver={handleVerifyDragOver} onDragLeave={handleVerifyDragLeave} onDrop={handleVerifyDrop} onMouseEnter={() => isHoveringRef.current = true} onMouseLeave={() => isHoveringRef.current = false}>
                    {isVerifyDragging && (<div className="absolute inset-0 bg-slate-900/90 z-20 flex flex-col items-center justify-center rounded-2xl backdrop-blur-sm border-2 border-dashed border-emerald-500 animate-in fade-in duration-200 pointer-events-none"><Upload className="w-12 h-12 text-emerald-400 mb-2 animate-bounce" /><h3 className="text-xl font-bold text-white">é‡‹æ”¾ä»¥åŠ å…¥åœ–ç‰‡</h3></div>)}
                    <div className="flex items-center gap-2 mb-3"><ShieldAlert className="w-5 h-5 text-red-400" /><h3 className="font-bold text-white">AI è¬ è¨€ç²‰ç¢æ©Ÿ</h3><span className="text-xs text-slate-400 ml-auto md:ml-2">æ­¤å€å°ˆé–€é©—è­‰çœŸå½èˆ‡æŸ¥æ ¸ä¾†æº</span></div>
                    <textarea id="verify-textarea" value={newsToVerify} onChange={(e) => setNewsToVerify(e.target.value)} placeholder="è½åˆ°å°é“æ¶ˆæ¯ï¼Ÿè²¼ä¸Šæ–‡å­—ã€æ–°èé€£çµ (URL) æˆ–ç›´æ¥æ‹–å…¥åœ–ç‰‡..." className="w-full flex-1 bg-black/30 border border-slate-700 rounded-lg p-3 text-xs text-white focus:outline-none focus:border-indigo-500 resize-none mb-3"></textarea>
                    {verifyImages.length > 0 && (<div className="mb-3 grid grid-cols-4 gap-2">{verifyImages.map((img, idx) => (<div key={idx} className="relative h-12 rounded-lg overflow-hidden border border-indigo-500/30 group"><img src={img} alt={`Evidence ${idx}`} className="w-full h-full object-cover" /><button onClick={() => removeVerifyImage(idx)} className="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity text-red-400 hover:text-red-300"><Trash2 className="w-4 h-4" /></button></div>))}</div>)}
                    <div className="flex gap-2"><input type="file" ref={verifyFileRef} onChange={handleVerifyImageSelect} accept="image/*" multiple className="hidden" /><button onClick={() => verifyFileRef.current.click()} className="flex-1 bg-slate-800 hover:bg-slate-700 text-slate-300 py-2 rounded-lg text-xs flex items-center justify-center gap-2 transition-colors border border-slate-700"><ImageIcon className="w-4 h-4" /> {verifyImages.length > 0 ? `å†åŠ å…¥åœ–ç‰‡ (${verifyImages.length})` : "ä¸Šå‚³æˆªåœ–"}</button><button onClick={handleVerifyNews} disabled={isVerifying || (!newsToVerify && verifyImages.length === 0)} className={`flex-1 py-2 rounded-lg font-bold text-sm flex items-center justify-center gap-2 transition-all ${isVerifying ? 'bg-slate-700 text-slate-500' : 'bg-indigo-600 hover:bg-indigo-500 text-white shadow-lg shadow-indigo-500/20'}`}>{isVerifying ? <RefreshCw className="w-4 h-4 animate-spin" /> : <FileSearch className="w-4 h-4" />}{isVerifying ? "AI æŸ¥æ ¸ä¸­..." : "é–‹å§‹é©—è­‰"}</button></div>
                </div>
            </div>
            {verificationResult && (<div className="bg-slate-800 border border-indigo-500/50 rounded-xl p-5 animate-in slide-in-from-top-4 shadow-2xl relative"><button onClick={() => setVerificationResult(null)} className="absolute top-3 right-3 text-slate-500 hover:text-white"><XCircle className="w-5 h-5" /></button><div className="flex items-start gap-3"><div className="p-2 bg-indigo-500/20 rounded-lg"><Bot className="w-6 h-6 text-indigo-400" /></div><div><h4 className="font-bold text-indigo-300 mb-2">AI æŸ¥æ ¸å ±å‘Š</h4><div className="prose prose-invert prose-sm text-slate-300 leading-relaxed whitespace-pre-line text-sm">{verificationResult}</div></div></div></div>)}
            {isGeneratingTheme ? (<div className="bg-slate-900/60 border border-slate-700 rounded-2xl p-12 flex flex-col items-center justify-center animate-pulse"><Loader2 className="w-12 h-12 text-indigo-500 animate-spin mb-4" /><h3 className="text-xl font-bold text-white mb-2">AI æˆ°æƒ…åˆ†æä¸­...</h3><p className="text-slate-400 text-sm">æ­£åœ¨èª¿ç”¨ Google Search æƒæä¾›æ‡‰éˆç†±åº¦èˆ‡é¾é ­è‚¡</p></div>) : generationError ? (<div className="bg-slate-900/60 border border-red-500/30 rounded-2xl p-12 flex flex-col items-center justify-center"><AlertTriangle className="w-12 h-12 text-red-500 mb-4" /><h3 className="text-xl font-bold text-white mb-2">åˆ†æå¤±æ•—</h3><p className="text-slate-400 text-sm mb-4">{generationError}</p><button onClick={() => window.location.reload()} className="px-4 py-2 bg-slate-700 rounded text-sm hover:bg-slate-600 transition-colors text-white">é‡æ•´é é¢</button></div>) : (activeTheme && activeTheme.segmentAnalysis) ? (<div className="bg-slate-900/60 border border-slate-700 rounded-2xl p-6 relative animate-fadeIn"><div className="absolute top-0 right-0 w-96 h-96 bg-indigo-600/5 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2 pointer-events-none"></div><div className="flex flex-col md:flex-row items-start justify-between gap-6 mb-8 relative z-10"><div><div className="flex items-center gap-3 mb-2"><h2 className="text-3xl font-bold text-white tracking-wide">{String(activeTheme.name)}</h2><span className={`text-xs font-bold px-2 py-0.5 rounded border ${activeTheme.hypeScore > 80 ? 'text-red-400 border-red-500/30 bg-red-900/20' : 'text-yellow-400 border-yellow-500/30 bg-yellow-900/20'}`}>{String(activeTheme.stage)}</span></div><p className="text-slate-400 text-sm max-w-2xl">{String(activeTheme.desc)}</p><div className="flex items-center gap-2 mt-3 text-sm text-slate-300 bg-slate-800/50 w-fit px-3 py-1 rounded-full border border-slate-700"><Zap className="w-3.5 h-3.5 text-yellow-400" /><span className="text-slate-500">å‚¬åŒ–åŠ‘ï¼š</span>{String(activeTheme.catalyst)}</div></div><div className="flex flex-col items-end"><div className="text-xs text-slate-500 mb-1">é¡Œæç¸½ç†±åº¦</div><div className="flex items-baseline gap-1"><span className={`text-4xl font-mono font-bold ${activeTheme.hypeScore > 85 ? 'text-red-500' : 'text-yellow-500'}`}>{String(activeTheme.hypeScore)}</span><span className="text-sm text-slate-600">/ 100</span></div></div></div><div className="grid grid-cols-1 md:grid-cols-3 gap-4 relative z-10"><SegmentCard title="ä¸Šæ¸¸ï¼šåŸæ–™/æ™¶ç‰‡" data={activeTheme.segmentAnalysis.upstream} /><SegmentCard title="ä¸­æ¸¸ï¼šæ¨¡çµ„/è¨­å‚™" data={activeTheme.segmentAnalysis.midstream} /><SegmentCard title="ä¸‹æ¸¸ï¼šçµ„è£/å“ç‰Œ" data={activeTheme.segmentAnalysis.downstream} /></div><div className="mt-4 text-center"><p className="text-[10px] text-slate-500 flex items-center justify-center gap-1"><Info className="w-3 h-3" /> æç¤ºï¼šé»æ“Šå€‹è‚¡å¯ç›´æ¥é–‹å•Ÿ K ç·šåœ–ã€‚å¸¶æœ‰ <Trophy className="w-3 h-3 text-yellow-500" /> æ¨™è¨˜ç‚ºè©²å€æ®µçœŸæ­£çš„é ˜é ­ç¾Šã€‚</p></div></div>) : null}
        </div>
    );
};

// --- AI Assistant (å¤šåœ–å‡ç´šç‰ˆ - åŠ å…¥ Hover æª¢æŸ¥) ---
const AIAssistant = () => {
    const [inputText, setInputText] = useState("");
    const [result, setResult] = useState("");
    const [isLoading, setIsLoading] = useState(false);
    
    // å¤šåœ–æ”¯æ´
    const [selectedImages, setSelectedImages] = useState([]);
    
    const [analysisMode, setAnalysisMode] = useState('comprehensive'); 
    const [stockCode, setStockCode] = useState(""); 
    const [isDragging, setIsDragging] = useState(false); 
    const fileInputRef = useRef(null);
    const isHoveringRef = useRef(false);
    
    const analysisModes = [
        { id: 'comprehensive', label: 'å…¨æ–¹ä½å¥è¨º', icon: <Activity className="w-4 h-4" />, color: 'bg-indigo-600' },
        { id: 'technical', label: 'æŠ€è¡“é¢ (Kç·š)', icon: <CandlestickChart className="w-4 h-4" />, color: 'bg-emerald-600' },
        { id: 'fundamental', label: 'åŸºæœ¬é¢ (åƒ¹å€¼)', icon: <PieChart className="w-4 h-4" />, color: 'bg-rose-600' },
        { id: 'chips', label: 'ç±Œç¢¼é¢ (ä¸»åŠ›)', icon: <Users className="w-4 h-4" />, color: 'bg-amber-600' },
    ];

    const processFiles = (files) => {
        Array.from(files).forEach(file => {
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onloadend = () => {
                    setSelectedImages(prev => [...prev, reader.result]);
                };
                reader.readAsDataURL(file);
            }
        });
    };

    const handleImageSelect = (e) => {
        processFiles(e.target.files);
    };

    const removeImage = (index) => {
        setSelectedImages(prev => prev.filter((_, i) => i !== index));
    };

    // Paste handling
    useEffect(() => {
        const handlePaste = (e) => {
            if (!isHoveringRef.current) return;
            // Logic similar to VerifyPaste
            if (!e.clipboardData || !e.clipboardData.items) return;
            const items = e.clipboardData.items;
            for (let i = 0; i < items.length; i++) {
                if (items[i].type.indexOf('image') !== -1) {
                    const blob = items[i].getAsFile();
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        setSelectedImages(prev => [...prev, reader.result]);
                    };
                    reader.readAsDataURL(blob);
                    e.preventDefault(); 
                }
            }
        };
        window.addEventListener('paste', handlePaste);
        return () => window.removeEventListener('paste', handlePaste);
    }, []);

    const handleDragOver = (e) => { e.preventDefault(); setIsDragging(true); };
    const handleDragLeave = (e) => { e.preventDefault(); setIsDragging(false); };
    const handleDrop = (e) => { e.preventDefault(); setIsDragging(false); processFiles(e.dataTransfer.files); };

    const handleAnalyze = async () => {
        if (!inputText.trim() && selectedImages.length === 0 && !stockCode.trim()) return;
        setIsLoading(true);
        setResult("");
        
        let prompt = inputText.trim();
        const today = new Date().toLocaleDateString('zh-TW');
        let modeInstruction = "";
        switch (analysisMode) {
            case 'technical': modeInstruction = "å°ˆæ³¨æ–¼æŠ€è¡“åˆ†æã€‚è­˜åˆ¥ K ç·šå‹æ…‹ (å¦‚ Wåº•ã€Mé ­ã€å³¶ç‹€åè½‰)ã€å‡ç·šæ’åˆ— (å¤šé ­/ç©ºé ­/ç³¾çµ)ã€MACD/RSI æŒ‡æ¨™èƒŒé›¢ã€‚è«‹çµ¦å‡ºæ˜ç¢ºçš„æ”¯æ’ä½èˆ‡å£“åŠ›ä½åƒ¹æ ¼ã€‚"; break;
            case 'fundamental': modeInstruction = "å°ˆæ³¨æ–¼åŸºæœ¬é¢åƒ¹å€¼ã€‚è‹¥åœ–ç‰‡åŒ…å«è²¡å ±æ•¸æ“š (EPS, ç‡Ÿæ”¶ YoY/MoM, æ¯›åˆ©ç‡)ï¼Œè«‹è©³ç´°è§£è®€ã€‚è‹¥ç„¡ï¼Œè«‹æ ¹æ“šæŠ€è¡“é¢æ¨æ¸¬å¸‚å ´å°è©²å…¬å¸åŸºæœ¬é¢çš„é æœŸã€‚"; break;
            case 'chips': modeInstruction = "å°ˆæ³¨æ–¼ç±Œç¢¼èˆ‡ä¸»åŠ›å‹•å‘ã€‚è§€å¯Ÿæˆäº¤é‡ (é‡åƒ¹é—œä¿‚)ï¼Œåˆ¤æ–·æ˜¯å¦æœ‰ä¸»åŠ›åƒè²¨ (é‡å¢åƒ¹ç©©) æˆ–å‡ºè²¨ (çˆ†é‡é•·é»‘)ã€‚"; break;
            case 'comprehensive': default: modeInstruction = "é€²è¡Œå…¨æ–¹ä½æ·±åº¦å¥è¨ºã€‚ç¶œåˆæŠ€è¡“é¢è¶¨å‹¢ã€ç±Œç¢¼é¢ä¸»åŠ›æ„åœ–èˆ‡åŸºæœ¬é¢æ½›åŠ›ã€‚çµ¦å‡ºä¸€å€‹ç¸½çµæ€§çš„æ“ä½œå»ºè­° (å¼·çƒˆè²·é€²/åˆ†æ‰¹ä½ˆå±€/è§€æœ›/è³£å‡º)ã€‚"; break;
        }
        const contextInfo = stockCode ? `ä½¿ç”¨è€…é—œæ³¨çš„è‚¡ç¥¨ä»£ç¢¼/åç¨±ç‚ºï¼šã€${stockCode}ã€‘ã€‚` : "ä½¿ç”¨è€…æœªæä¾›å…·é«”ä»£ç¢¼ï¼Œè«‹å˜—è©¦å¾åœ–ç‰‡ä¸­è¾¨è­˜ã€‚";
        const systemPrompt = `ä½ ç¾åœ¨æ˜¯ JAMESï¼Œä¸€ä½é ‚å°–çš„é‡‘èåˆ†æå¸«ã€‚ä»Šå¤©æ˜¯ ${today}ã€‚${contextInfo} ä½ çš„åˆ†æä»»å‹™å¦‚ä¸‹ï¼š1. **${modeInstruction}** 2. **æ·±åº¦è§£è®€**ï¼šä¸è¦åªæè¿°ã€Œè‚¡åƒ¹ä¸Šæ¼²ã€æˆ–ã€Œä¸‹è·Œã€ï¼Œè¦è§£é‡‹ã€Œç‚ºä»€éº¼ã€ã€‚3. **æ•¸æ“šé©—è­‰**ï¼šè«‹å¼•ç”¨æ•¸æ“šä½è­‰ã€‚4. **æ“ä½œå»ºè­°**ï¼šçµ¦å‡ºå…·é«”çš„ç­–ç•¥ã€‚è«‹ç”¨å°ˆæ¥­ã€çŠ€åˆ©ä¸”å…·å¯¦æˆ°æ€§çš„å£å»å›ç­”ã€‚ä½¿ç”¨ Markdown æ ¼å¼ã€‚`;

        try {
            const response = await callGeminiAPI(prompt, selectedImages, systemPrompt, true);
            setResult(response);
        } catch (e) {
            setResult(`åˆ†æéŒ¯èª¤: ${e.message}`);
        } finally {
            setIsLoading(false);
        }
    };

    const renderMarkdown = (text) => {
        if (window.marked) {
            return { __html: window.marked.parse(text) };
        }
        return { __html: text.replace(/\n/g, '<br/>') }; 
    };

    return (
        <div 
            className={`w-full max-w-[96%] mx-auto mb-10 bg-gradient-to-br from-indigo-900/40 to-purple-900/40 p-1 rounded-2xl border transition-all duration-300 shadow-lg relative overflow-hidden group focus:outline-none ${isDragging ? 'border-emerald-500 scale-[1.01] shadow-emerald-500/20' : 'border-indigo-500/30'}`}
            onDragOver={handleDragOver}
            onDragLeave={handleDragLeave}
            onDrop={handleDrop}
            onMouseEnter={() => isHoveringRef.current = true}
            onMouseLeave={() => isHoveringRef.current = false}
        >
            <div className="absolute inset-0 bg-gradient-to-r from-transparent via-indigo-500/10 to-transparent translate-x-[-100%] group-hover:translate-x-[100%] transition-transform duration-1000 pointer-events-none"></div>
            {isDragging && (
                <div className="absolute inset-0 bg-slate-900/90 z-50 flex flex-col items-center justify-center rounded-2xl backdrop-blur-sm border-2 border-dashed border-emerald-500 animate-in fade-in duration-200">
                    <Upload className="w-16 h-16 text-emerald-400 mb-4 animate-bounce" />
                    <h3 className="text-2xl font-bold text-white">é‡‹æ”¾æ»‘é¼ ä»¥é–‹å§‹åˆ†æ</h3>
                </div>
            )}
            <div className="bg-slate-900/90 rounded-xl p-6 h-full backdrop-blur-sm">
                <div className="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
                    <div className="flex items-center gap-3">
                        <div className="bg-indigo-600 p-2 rounded-lg text-white shadow-lg shadow-indigo-500/30"><Sparkles className="w-6 h-6 animate-pulse" /></div>
                        <div>
                            <h3 className="text-xl font-bold text-white flex items-center gap-2">AI æ™ºèƒ½è²¡ç¶“åŠ©æ‰‹ <span className="text-xs font-normal px-2 py-0.5 rounded-full bg-gradient-to-r from-pink-500 to-purple-600 text-white border border-white/20">Pro</span></h3>
                            <p className="text-slate-400 text-xs">è²¼ä¸Š (Ctrl+V) å¤šå¼µæˆªåœ–ï¼ŒAI è‡ªå‹•æ·±åº¦åˆ¤è®€å¤šç©º</p>
                        </div>
                    </div>
                    <div className="flex bg-slate-800/80 p-1 rounded-lg border border-slate-700 overflow-x-auto no-scrollbar">
                        {analysisModes.map(mode => (
                            <button key={mode.id} onClick={() => setAnalysisMode(mode.id)} className={`flex items-center gap-1.5 px-3 py-1.5 rounded-md text-xs font-bold transition-all whitespace-nowrap ${analysisMode === mode.id ? `${mode.color} text-white shadow-md` : 'text-slate-400 hover:text-white hover:bg-slate-700'}`}>
                                {mode.icon}
                                {mode.label}
                            </button>
                        ))}
                    </div>
                </div>
                <div className="mb-4 grid grid-cols-1 md:grid-cols-3 gap-3">
                    <div className="md:col-span-1">
                        <label className="block text-xs text-slate-500 mb-1 ml-1">è‚¡ç¥¨ä»£ç¢¼/åç¨± (é¸å¡«)</label>
                        <input type="text" value={stockCode} onChange={(e) => setStockCode(e.target.value)} placeholder="ä¾‹ï¼š2330 å°ç©é›»" className="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm text-white focus:outline-none focus:border-indigo-500 placeholder-slate-600" />
                    </div>
                    <div className="md:col-span-2">
                        <label className="block text-xs text-slate-500 mb-1 ml-1">è£œå……è³‡è¨Š (é¸å¡«)</label>
                        <input type="text" value={inputText} onChange={(e) => setInputText(e.target.value)} placeholder="å»ºè­°è¼¸å…¥ï¼šæ–°èç¶²å€ (URL)ã€ç›®å‰è‚¡åƒ¹ã€æœ€æ–°åˆ©å¤š..." className="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm text-white focus:outline-none focus:border-indigo-500 placeholder-slate-600" />
                    </div>
                </div>
                
                {selectedImages.length > 0 && (
                    <div className="mb-4 grid grid-cols-4 md:grid-cols-6 gap-3 animate-fadeIn">
                        {selectedImages.map((img, idx) => (
                            <div key={idx} className="relative h-20 rounded-lg overflow-hidden border border-slate-600 shadow-md group">
                                <img src={img} alt={`Preview ${idx}`} className="w-full h-full object-cover" />
                                <button onClick={() => removeImage(idx)} className="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity text-white">
                                    <XCircle className="w-6 h-6" />
                                </button>
                            </div>
                        ))}
                    </div>
                )}

                <div className="space-y-4">
                    <div className="relative">
                        <div className="flex justify-end items-center gap-3 mt-2 border-t border-slate-800 pt-3">
                            <span className="text-xs text-slate-500 mr-auto flex items-center gap-1"><Info className="w-3 h-3" /> {analysisMode === 'technical' ? 'AI å°‡å°ˆæ³¨æ–¼å½¢æ…‹å­¸èˆ‡æŒ‡æ¨™åˆ¤è®€' : 'æ”¯æ´å¤šåœ–èˆ‡é€£çµåˆ†æ'}</span>
                            <input type="file" ref={fileInputRef} onChange={handleImageSelect} accept="image/*" multiple className="hidden" />
                            <button onClick={() => fileInputRef.current.click()} className="flex items-center gap-2 px-3 py-2 text-slate-400 hover:text-white bg-slate-800 hover:bg-slate-700 rounded-lg transition-colors border border-slate-700" title="ä¸Šå‚³åœ–ç‰‡"><ImageIcon className="w-4 h-4" /><span className="text-xs font-medium">ä¸Šå‚³åœ–ç‰‡</span></button>
                            <button onClick={handleAnalyze} disabled={isLoading || (!inputText.trim() && selectedImages.length === 0 && !stockCode.trim())} className={`px-6 py-2 rounded-lg text-sm font-bold flex items-center gap-2 transition-all shadow-lg ${isLoading || (!inputText.trim() && selectedImages.length === 0 && !stockCode.trim()) ? 'bg-slate-700 text-slate-500 cursor-not-allowed' : 'bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 text-white shadow-indigo-500/25'}`}>
                                {isLoading ? <RefreshCw className="w-4 h-4 animate-spin" /> : <Send className="w-4 h-4" />}
                                {isLoading ? "æ·±åº¦è§£æä¸­..." : "é–‹å§‹è¨ºæ–·"}
                            </button>
                        </div>
                    </div>
                    {result && (
                        <div className="bg-slate-800/50 border border-slate-700 rounded-lg p-5 animate-fadeIn shadow-inner">
                            <div className="flex items-start gap-3">
                                <div className="mt-1 p-1.5 bg-indigo-500/20 rounded-full"><Bot className="w-5 h-5 text-indigo-400 flex-shrink-0" /></div>
                                <div className="prose prose-invert prose-sm max-w-none text-slate-300 leading-relaxed marker:text-indigo-400" dangerouslySetInnerHTML={renderMarkdown(result)} />
                            </div>
                            <div className="mt-4 pt-3 border-t border-slate-700/50 flex justify-between items-center text-xs text-slate-500">
                                <span>åˆ†ææ¨¡å‹ï¼šGemini 2.5 Flash</span>
                                <span>åƒ…ä¾›åƒè€ƒï¼ŒæŠ•è³‡è«‹è‡ªè² ç›ˆè™§</span>
                            </div>
                        </div>
                    )}
                </div>
            </div>
        </div>
    );
};

// --- LiveQuantScanner v6.0 (è¯çˆ¾è¡—æ——è‰¦ç‰ˆ) ---
const LiveQuantScanner = ({ openChart, addToWatchlist }) => {
    const [activeStrategy, setActiveStrategy] = useState('momentum_alpha');
    const [isScanning, setIsScanning] = useState(false);
    const [scanResults, setScanResults] = useState(null);
    const [scanProgress, setScanProgress] = useState(0);
    const [lastScanTime, setLastScanTime] = useState(null);
    const [errorMsg, setErrorMsg] = useState(null);

    const strategies = useMemo(() => ({
        'momentum_alpha': {
            id: 'momentum_alpha', title: 'Alpha å‹•èƒ½ç‹™æ“Š', tag: 'Momentum Scalping', icon: <ZapIcon className="w-5 h-5" />, color: 'text-amber-400', bg: 'bg-amber-500/10', border: 'border-amber-500/50',
            desc: 'é‡å°é«˜æ³¢å‹•ç‡èˆ‡æˆäº¤é‡ç•°å¸¸æ”¾å¤§çš„æ¨™çš„ï¼Œæ•æ‰çŸ­ç·šå‹•èƒ½çªç ´ã€‚',
            logic: ['Volume > 5æ—¥å‡é‡ 2.5å€', 'RSI (14) > 65 ä¸” < 85 (éˆåŒ–å‰)', 'ä¹–é›¢ç‡ Bias > 3%'],
            searchQuery: "å°è‚¡ ä»Šæ—¥ æˆäº¤é‡çˆ†å¢ å¼·å‹¢è‚¡ RSIå¼·å‹¢ ä¹–é›¢ç‡æ“´å¤§"
        },
        'institutional_lock': {
            id: 'institutional_lock', title: 'æ³•äººé–ç¢¼è·Ÿå–®', tag: 'Smart Money Flow', icon: <Briefcase className="w-5 h-5" />, color: 'text-indigo-400', bg: 'bg-indigo-500/10', border: 'border-indigo-500/50',
            desc: 'è¿½è¹¤å¤–è³‡èˆ‡æŠ•ä¿¡é€£çºŒè²·è¶…ï¼Œä¸”è‚¡åƒ¹å°šæœªå™´å‡ºçš„ã€Œè“„å‹¢å¾…ç™¼ã€è‚¡ã€‚',
            logic: ['æŠ•ä¿¡é€£è²· > 3æ—¥', 'ä¸»åŠ›é›†ä¸­åº¦ > 15%', 'è‚¡åƒ¹åœ¨ 20MA ä¹‹ä¸Šæ•´ç†'],
            searchQuery: "å°è‚¡ ä»Šæ—¥ æŠ•ä¿¡è²·è¶… ä¸»åŠ›é–ç¢¼ ç±Œç¢¼é›†ä¸­ è“„å‹¢å¾…ç™¼"
        },
        'volatility_breakout': {
            id: 'volatility_breakout', title: 'æ³¢å‹•ç‡çªç ´ (VCP)', tag: 'Volatility Breakout', icon: <Activity className="w-5 h-5" />, color: 'text-emerald-400', bg: 'bg-emerald-500/10', border: 'border-emerald-500/50',
            desc: 'å°‹æ‰¾åƒ¹æ ¼å£“ç¸®æ¥µè‡´å¾Œçš„å¸¶é‡çªç ´ (Mark Minervini VCP å‹æ…‹)ã€‚',
            logic: ['å¸ƒæ—é€šé“å£“ç¸® (Bandwidth < 5%)', 'çªç ´ä¸Šè»Œ', 'ATR å¢åŠ '],
            searchQuery: "å°è‚¡ ä»Šæ—¥ å¸ƒæ—é€šé“çªç ´ ç›¤æ•´çªç ´ VCPå‹æ…‹"
        }
    }), []);

    const scanMarket = async () => {
        setIsScanning(true);
        setScanResults(null);
        setErrorMsg(null);
        setScanProgress(0);

        const progressInterval = setInterval(() => {
            setScanProgress(prev => {
                if (prev >= 90) return prev;
                return prev + Math.floor(Math.random() * 15);
            });
        }, 500);
        
        const strategy = strategies[activeStrategy];
        const now = new Date();
        const todayStr = now.toLocaleString('zh-TW', { hour12: false });
        
        const prompt = `è«‹æ‰®æ¼”è¯çˆ¾è¡—é ‚å°–çš„é‡åŒ–äº¤æ˜“æ¼”ç®—æ³• (Quant Algo)ã€‚ç¾åœ¨æ™‚é–“ï¼š${todayStr}ã€‚
        äº¤æ˜“ç­–ç•¥æ¨¡å‹ï¼šã€${strategy.title}ã€‘
        
        ä»»å‹™ï¼š
        1. **æ·±åº¦æƒæ**ï¼šä½¿ç”¨ Google Search æœå°‹ã€Œä»Šæ—¥ã€å°è‚¡å¸‚å ´ï¼Œæ‰¾å‡º 4 æª”æœ€ç¬¦åˆè©²ç­–ç•¥é‚è¼¯çš„æ½›åŠ›è‚¡ã€‚
        2. **å³æ™‚å®šåƒ¹**ï¼šå¿…é ˆç²å–ä»Šæ—¥æœ€æ–°å³æ™‚è‚¡åƒ¹ (Price) èˆ‡ æ¼²è·Œå¹… (Change)ã€‚
        3. **é‡åŒ–é‹ç®—**ï¼šè«‹ç‚ºæ¯ä¸€æª”è‚¡ç¥¨è¨ˆç®—ä»¥ä¸‹äº¤æ˜“åƒæ•¸ (è‹¥ç„¡ç²¾ç¢ºæ•¸æ“šï¼Œè«‹ä¾æŠ€è¡“é¢é‚è¼¯æ¨ç®—åˆç†çš„æ•¸å€¼)ï¼š
        - **æ”¯æ’ä½ (Support)**: ä¸‹æª”é—œéµé˜²å®ˆåƒ¹ã€‚
        - **å£“åŠ›ä½ (Resistance)**: ä¸Šæª”ç›®æ¨™åƒ¹ã€‚
        - **å»ºè­°é€²å ´åƒ¹ (Entry Zone)**: ç›®å‰åƒ¹æ ¼é™„è¿‘çš„åˆç†å€é–“ã€‚
        - **åœæåƒ¹ (Stop Loss)**: åš´æ ¼é¢¨æ§é» (é€šå¸¸æ˜¯æ”¯æ’ä½ä¸‹æ–¹ 2-3%)ã€‚
        - **åœåˆ©åƒ¹ (Take Profit)**: é æœŸæ³¢æ®µæ»¿è¶³é»ã€‚
        - **é æœŸæ¼²å¹… (Upside)**: (åœåˆ©åƒ¹ - ç¾åƒ¹) / ç¾åƒ¹ %ã€‚
        - **å‹ç‡ (Win Rate)**: æ ¹æ“šå‹æ…‹å®Œæ•´åº¦çµ¦äºˆ 0-100% çš„ä¿¡å¿ƒåˆ†æ•¸ã€‚
        - **é¢¨å ±æ¯” (RR Ratio)**: (åœåˆ©-é€²å ´)/(é€²å ´-åœæ)ï¼Œæ ¼å¼å¦‚ "1:2.5"ã€‚
        - **è¨Šè™Ÿæ¨™ç±¤**: å¦‚ "BULLISH BREAKOUT", "STRONG BUY", "ACCUMULATION"ã€‚
        
        ã€æ¥µé‡è¦ï¼šè¼¸å‡ºæ ¼å¼ã€‘
        è«‹åªå›å‚³ä¸€å€‹æ¨™æº–çš„ JSON Arrayã€‚ä¸è¦åŒ…å« Markdownï¼Œä¸è¦åŒ…å«ä»»ä½•å‰è¨€å¾Œèªã€‚
        æ ¼å¼å¿…é ˆæ˜¯ç´”ç²¹çš„é™£åˆ—ï¼š[{...}, {...}, {...}, {...}]
        
        æ ¼å¼ç¯„ä¾‹ï¼š
        [
        {
            "code": "2330",
            "name": "å°ç©é›»",
            "price": "1000",
            "change": "+2.5%",
            "signal_tag": "STRONG BUY",
            "win_rate": 88,
            "upside": "15%",
            "rr_ratio": "1:3.2",
            "support": "980",
            "resistance": "1050",
            "entry_zone": "995-1005",
            "stop_loss": "970",
            "take_profit": "1080",
            "reason": "é‡åŒ–æ¨¡å‹åµæ¸¬åˆ°å¤–è³‡è²·ç›¤æ¹§å…¥ï¼ŒRSI é»ƒé‡‘äº¤å‰ï¼Œçªç ´ä¸‹é™è¶¨å‹¢ç·šã€‚"
        }
        ]`;

        try {
            const systemInstruction = `ä½ æ˜¯ä¸€å€‹é«˜é »é‡åŒ–äº¤æ˜“ç³»çµ±ã€‚ç¾åœ¨æ™‚é–“æˆ³è¨˜ï¼š${now.toISOString()}ã€‚ä½ çš„ä»»å‹™æ˜¯æ¨¡æ“¬å°ˆæ¥­çœ‹ç›¤è»Ÿé«”çš„è¨Šè™Ÿè¼¸å‡ºã€‚åš´æ ¼ä½¿ç”¨ Google Search ç²å–æœ€æ–°å ±åƒ¹ã€‚åªè¼¸å‡º JSON é™£åˆ—ã€‚çµ•å°ä¸è¦ä½¿ç”¨ Markdown æ ¼å¼ã€‚`;
            const resultText = await callGeminiAPI(prompt, [], systemInstruction, true, true);
            
            const results = safeParseJSON(resultText);
            
            clearInterval(progressInterval);
            setScanProgress(100);
            
            // Auto-fix: è‡ªå‹•æœå°‹ä¸¦æå– JSON ä¸­çš„ä»»ä½•é™£åˆ—
            let finalResults = [];
            if (Array.isArray(results)) {
                finalResults = results;
            } else if (results && typeof results === 'object') {
                // å¦‚æœ AI å›å‚³äº†ç‰©ä»¶ (ä¾‹å¦‚ { result: [...] })ï¼Œå˜—è©¦æ‰¾å‡ºå…¶ä¸­çš„é™£åˆ—
                for (const key in results) {
                    if (Array.isArray(results[key])) {
                        finalResults = results[key];
                        break;
                    }
                }
            }

            if (finalResults.length > 0) {
                setScanResults(finalResults);
                setLastScanTime(new Date());
            } else {
                throw new Error("AI å›å‚³æ ¼å¼ç„¡æ³•è§£æç‚ºé™£åˆ—ï¼Œè«‹é‡è©¦");
            }
        } catch (e) {
            console.error("Scan failed:", e);
            setErrorMsg(`é‡åŒ–å¼•æ“é€£ç·šé€¾æ™‚ï¼š${e.message || "è«‹é‡è©¦"}`);
            setScanResults([]); 
            clearInterval(progressInterval);
        } finally {
            setTimeout(() => setIsScanning(false), 500); 
        }
    };

    const activeData = strategies[activeStrategy];

    // æ¸²æŸ“é‡åŒ–å¡ç‰‡
    const QuantCard = ({ stock }) => (
        <div className="bg-[#1e222d] border border-slate-700 hover:border-blue-500/50 rounded-xl overflow-hidden shadow-lg group transition-all duration-300 hover:-translate-y-1 relative">
            <div className={`h-1 w-full bg-gradient-to-r ${String(stock.change || '').includes('-') ? 'from-green-500 to-emerald-600' : 'from-red-500 to-orange-500'}`}></div>
            
            <div className="p-5">
                <div className="flex justify-between items-start mb-4">
                    <div>
                        <div className="flex items-center gap-2 mb-1">
                            <span className="bg-slate-700 text-slate-300 text-[10px] font-mono px-1.5 py-0.5 rounded">{String(stock.code || '---')}</span>
                            <h3 className="text-lg font-bold text-white tracking-wide">{String(stock.name || '---')}</h3>
                        </div>
                        <div className="flex items-baseline gap-2">
                            <span className={`text-3xl font-mono font-bold ${String(stock.change || '').includes('-') ? 'text-emerald-400' : 'text-red-500'}`}>{String(stock.price || '---')}</span>
                            <span className={`text-sm font-bold ${String(stock.change || '').includes('-') ? 'text-emerald-400' : 'text-red-500'}`}>{String(stock.change || '---')}</span>
                        </div>
                    </div>
                    <div className="text-right flex flex-col items-end">
                        <span className={`text-[10px] font-bold px-2 py-1 rounded border mb-1 ${stock.win_rate >= 80 ? 'bg-red-900/20 text-red-400 border-red-500/30' : 'bg-blue-900/20 text-blue-400 border-blue-500/30'}`}>
                            {String(stock.signal_tag || 'HOLD')}
                        </span>
                        <div className="flex items-center gap-1 text-slate-400 text-xs">
                        <Target className="w-3 h-3" /> å‹ç‡ {String(stock.win_rate || '0')}%
                        </div>
                    </div>
                </div>

                <div className="bg-[#131722] rounded-lg p-3 border border-slate-700/50 mb-4">
                    <div className="grid grid-cols-3 gap-2 text-center divide-x divide-slate-700">
                        <div>
                            <div className="text-[10px] text-slate-500 mb-1">é€²å ´å€é–“</div>
                            <div className="text-sm font-mono text-yellow-400 font-bold">{String(stock.entry_zone || '---')}</div>
                        </div>
                        <div>
                            <div className="text-[10px] text-slate-500 mb-1">åœåˆ©ç›®æ¨™</div>
                            <div className="text-sm font-mono text-emerald-400 font-bold">{String(stock.take_profit || '---')}</div>
                        </div>
                        <div>
                            <div className="text-[10px] text-slate-500 mb-1">åœæé˜²å®ˆ</div>
                            <div className="text-sm font-mono text-red-400 font-bold">{String(stock.stop_loss || '---')}</div>
                        </div>
                    </div>
                </div>

                <div className="grid grid-cols-2 gap-3 mb-4">
                    <div className="flex justify-between items-center bg-slate-800/50 px-3 py-2 rounded">
                        <span className="text-xs text-slate-400">é æœŸæ¼²å¹…</span>
                        <span className="text-sm font-bold text-blue-300">+{String(stock.upside || '---')}</span>
                    </div>
                    <div className="flex justify-between items-center bg-slate-800/50 px-3 py-2 rounded">
                        <span className="text-xs text-slate-400">é¢¨å ±æ¯” RR</span>
                        <span className="text-sm font-bold text-purple-300">{String(stock.rr_ratio || '---')}</span>
                    </div>
                </div>

                <div className="text-xs text-slate-400 leading-relaxed border-t border-slate-700 pt-3">
                    <span className="text-blue-500 font-bold mr-1">[AI æ¼”ç®—]</span>
                    {String(stock.reason || 'æ­£åœ¨åˆ†æä¸­...')}
                </div>
            </div>

            <div className="grid grid-cols-2 border-t border-slate-700">
                <button onClick={() => openChart(stock.code)} className="py-3 flex items-center justify-center gap-2 text-xs font-bold text-slate-300 hover:bg-slate-700 transition-colors border-r border-slate-700">
                    <Activity className="w-4 h-4" /> K ç·šç¢ºèª
                </button>
                <button onClick={() => addToWatchlist(stock.code)} className="py-3 flex items-center justify-center gap-2 text-xs font-bold text-emerald-400 hover:bg-emerald-900/20 transition-colors">
                    <Plus className="w-4 h-4" /> åŠ å…¥ç›£æ§
                </button>
            </div>
        </div>
    );

    return (
        <div className="animate-fadeIn space-y-6">
            <div className="bg-[#131722] border border-slate-700 rounded-2xl p-6 md:p-8 shadow-2xl">
                <div className="flex flex-col md:flex-row items-center justify-between gap-6 mb-8">
                    <div className="flex items-center gap-4">
                        <div className="p-3 bg-blue-600 rounded-xl shadow-lg shadow-blue-500/20 relative group overflow-hidden">
                            <div className="absolute inset-0 bg-white/30 translate-y-full group-hover:translate-y-0 transition-transform duration-500"></div>
                            <Binary className="w-8 h-8 text-white" />
                        </div>
                        <div>
                            <h2 className="text-2xl font-bold text-white flex items-center gap-2 tracking-wide">
                                AI å¯¦æˆ°é‡åŒ–é›·é” <span className="text-[10px] bg-blue-500 text-white px-1.5 py-0.5 rounded font-mono">v6.0 PRO</span>
                            </h2>
                            <p className="text-slate-400 text-xs mt-1">Institutional Grade Quantitative Scanning â€¢ è¯çˆ¾è¡—ç´šæ¼”ç®—æ³•</p>
                        </div>
                    </div>
                    
                    {/* ç­–ç•¥é¸æ“‡å™¨ */}
                    <div className="flex bg-[#0b0e14] p-1 rounded-lg border border-slate-700">
                        {Object.values(strategies).map(strat => (
                            <button
                                key={strat.id}
                                onClick={() => { setActiveStrategy(strat.id); setScanResults(null); }}
                                className={`px-4 py-2 rounded-md text-xs font-bold transition-all flex items-center gap-2 ${activeStrategy === strat.id ? 'bg-slate-700 text-white shadow' : 'text-slate-500 hover:text-slate-300'}`}
                            >
                                {strat.icon} <span className="hidden md:inline">{strat.title}</span>
                            </button>
                        ))}
                    </div>
                </div>

                {/* æƒææ§åˆ¶å€ */}
                {!scanResults && !isScanning && (
                    <div className="text-center py-12 border-2 border-dashed border-slate-700 rounded-2xl bg-slate-800/20">
                        <div className="max-w-lg mx-auto">
                            <Radar className="w-16 h-16 text-slate-600 mx-auto mb-4 animate-pulse" />
                            <h3 className="text-xl font-bold text-white mb-2">{activeData.title}</h3>
                            <p className="text-slate-400 text-sm mb-6">{activeData.desc}</p>
                            
                            <div className="flex flex-wrap justify-center gap-2 mb-8">
                                {activeData.logic.map((rule, i) => (
                                    <span key={i} className="text-[10px] bg-slate-800 text-slate-300 px-2 py-1 rounded border border-slate-600 font-mono">
                                        {rule}
                                    </span>
                                ))}
                            </div>

                            <button onClick={scanMarket} className="group relative px-8 py-4 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-xl shadow-lg shadow-blue-500/30 transition-all hover:scale-105 overflow-hidden">
                                <div className="absolute inset-0 bg-white/20 translate-x-[-100%] group-hover:translate-x-[100%] transition-transform duration-700"></div>
                                <span className="flex items-center gap-2 text-lg"><ZapIcon className="w-5 h-5 fill-current" /> å•Ÿå‹• AI é‡åŒ–é‹ç®—</span>
                            </button>
                        </div>
                    </div>
                )}

                {/* æƒæé€²åº¦æ¢ */}
                {isScanning && (
                    <div className="py-20 text-center">
                        <Loader2 className="w-12 h-12 text-blue-500 animate-spin mx-auto mb-6" />
                        <h3 className="text-2xl font-bold text-white mb-2 tracking-widest">CALCULATING ALPHA...</h3>
                        <p className="text-blue-400 font-mono text-sm mb-6">æ­£åœ¨åŸ·è¡Œå¤šå› å­å›æ¸¬èˆ‡å³æ™‚å ±åƒ¹é‹ç®—</p>
                        <div className="w-64 h-2 bg-slate-800 rounded-full mx-auto overflow-hidden">
                            <div className="h-full bg-blue-500 transition-all duration-300 ease-out" style={{ width: `${scanProgress}%` }}></div>
                        </div>
                        <div className="mt-2 text-xs text-slate-500 font-mono">{scanProgress}% COMPLETED</div>
                    </div>
                )}

                {/* çµæœå±•ç¤ºå€ */}
                {scanResults && (
                    <div className="animate-in fade-in slide-in-from-bottom-8 duration-700">
                        <div className="flex justify-between items-center mb-4 px-2">
                            <div className="text-sm text-slate-400">
                                <span className="text-green-400 font-bold">â— System Online</span> <span className="mx-2">|</span> ç­–ç•¥ï¼š{activeData.title} <span className="mx-2">|</span> æƒææ™‚é–“ï¼š{lastScanTime?.toLocaleTimeString()}
                            </div>
                            <button onClick={scanMarket} className="text-xs flex items-center gap-1 text-blue-400 hover:text-blue-300 transition-colors"><RefreshCw className="w-3 h-3" /> é‡æ–°æƒæ</button>
                        </div>
                        
                        {errorMsg ? (
                            <div className="bg-red-900/20 border border-red-500/50 p-4 rounded-xl text-center text-red-200">
                                <AlertTriangle className="w-6 h-6 mx-auto mb-2" />
                                {errorMsg}
                            </div>
                        ) : (
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                                {scanResults.map((stock, idx) => (
                                    <QuantCard key={idx} stock={stock} />
                                ))}
                            </div>
                        )}
                        <div className="mt-6 p-3 bg-blue-900/10 border border-blue-500/20 rounded-lg flex items-center gap-3 text-xs text-slate-400">
                            <Info className="w-4 h-4 text-blue-400 flex-shrink-0" />
                            <span>å…è²¬è²æ˜ï¼šæœ¬é‡åŒ–é›·é”åƒ…ç‚º AI è¼”åŠ©åˆ†æå·¥å…·ï¼Œæ‰€æœ‰é€²å‡ºå ´é»ä½ï¼ˆEntry/TP/SLï¼‰å‡ç‚ºæ¼”ç®—æ³•æ¨¡æ“¬æ¨ç®—ï¼Œä¸¦éæŠ•è³‡å»ºè­°ã€‚å³æ™‚å ±åƒ¹å¯èƒ½èˆ‡åˆ¸å•†è»Ÿé«”æœ‰å»¶é²ï¼Œä¸‹å–®å‰è«‹å‹™å¿…å†æ¬¡ç¢ºèªã€‚</span>
                        </div>
                    </div>
                )}
            </div>
        </div>
    );
};

const TWHotLists = () => {
    const [activeFilter, setActiveFilter] = useState('most_active');
    const [lookupCode, setLookupCode] = useState('');
    const [lookupResult, setLookupResult] = useState(null); 
    const [lastUpdated, setLastUpdated] = useState(new Date());
    const containerRef = useRef(null);

    const filters = [
        { id: 'most_active', label: 'ğŸ”¥ çˆ†é‡é•·ç´… (è³‡é‡‘æµå‘)', color: 'text-violet-300', bg: 'bg-violet-900/40', border: 'border-violet-500' },
        { id: 'top_gainers', label: 'ğŸš€ å¼·å‹¢æ¼²åœ', color: 'text-rose-300', bg: 'bg-rose-900/40', border: 'border-rose-500' },
        { id: 'top_losers', label: 'ğŸ“‰ å¼±å‹¢è·Œåœ', color: 'text-emerald-300', bg: 'bg-emerald-900/40', border: 'border-emerald-500' },
    ];

    useEffect(() => {
        setLastUpdated(new Date());
        let container = containerRef.current;
        if (container) {
            container.innerHTML = '';
            const script = document.createElement('script');
            script.src = 'https://s3.tradingview.com/external-embedding/embed-widget-screener.js';
            script.async = true;
            script.innerHTML = JSON.stringify({
                "width": "100%",
                "height": 550,
                "defaultColumn": "overview",
                "defaultScreen": activeFilter,
                "market": "taiwan",
                "showToolbar": false,
                "colorTheme": "dark",
                "locale": "zh_TW"
            });
            container.appendChild(script);
        }
        return () => {
            if(container) container.innerHTML = '';
        }
    }, [activeFilter]);

    const handleLookup = (e) => {
        const input = e.target.value.trim();
        setLookupCode(input);
        if (input.length >= 2) { 
            const upperInput = input.toUpperCase();
            if (STOCK_NAMES[upperInput]) {
                setLookupResult({ type: 'code', code: upperInput, name: STOCK_NAMES[upperInput] });
                return;
            }
            const foundCode = Object.keys(STOCK_NAMES).find(key => STOCK_NAMES[key].includes(input));
            if (foundCode) {
                setLookupResult({ type: 'name', code: foundCode, name: STOCK_NAMES[foundCode] });
                return;
            }
            setLookupResult({ type: 'not_found', input: input });
        } else {
            setLookupResult(null);
        }
    };

    return (
        <div className="animate-fadeIn bg-slate-800/50 border border-slate-700/50 rounded-2xl p-4 md:p-6">
            <div className="flex flex-col gap-4 mb-4">
                <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
                    <div className="flex items-center gap-3">
                        <div className="p-2 bg-rose-600 rounded-lg shadow-lg"><Flame className="w-6 h-6 text-white" /></div>
                        <div>
                            <h2 className="text-xl font-bold text-white flex items-center gap-2">
                                å°è‚¡ç†±é–€æ’è¡Œ
                                <span className="text-[10px] font-normal px-2 py-0.5 rounded-full bg-emerald-900/50 text-emerald-400 border border-emerald-500/30 flex items-center gap-1 animate-pulse">
                                    <span className="w-1.5 h-1.5 rounded-full bg-emerald-500"></span>è¨Šè™Ÿæ›´æ–°ä¸­
                                </span>
                            </h2>
                            <p className="text-slate-400 text-xs flex items-center gap-1">
                                <Clock className="w-3 h-3" />æœ€å¾Œæ›´æ–°ï¼š{lastUpdated.toLocaleTimeString()} (è³‡æ–™æºï¼šTradingView)
                            </p>
                        </div>
                    </div>
                    <div className="relative group w-full md:w-auto">
                        <div className="flex items-center gap-2 bg-slate-900/80 border border-slate-600 rounded-lg px-3 py-2 focus-within:border-blue-500 transition-colors">
                            <Search className="w-4 h-4 text-slate-400" />
                            <input type="text" placeholder="æ™ºèƒ½è§£ç¢¼ï¼šè¼¸å…¥ 2330 æˆ– å°ç©é›»" className="bg-transparent border-none text-sm text-white placeholder-slate-500 focus:outline-none w-full md:w-64" value={lookupCode} onChange={handleLookup} />
                        </div>
                        {lookupResult && (
                            <div className="absolute top-full left-0 right-0 mt-2 bg-slate-800 border border-slate-600 rounded-lg p-3 shadow-xl z-20 text-center animate-in slide-in-from-top-2">
                                <p className="text-xs text-slate-400 mb-1">æ™ºèƒ½è§£ç¢¼çµæœ</p>
                                {lookupResult.type === 'not_found' ? (
                                    <div className="flex flex-col gap-2">
                                        <p className="text-sm text-slate-500">å…§å»ºå­—å…¸æŸ¥ç„¡è³‡æ–™ (å¯èƒ½ç‚ºå†·é–€è‚¡)</p>
                                        <a href={`https://tw.stock.yahoo.com/quote/${lookupResult.input}`} target="_blank" rel="noopener noreferrer" className="text-xs bg-indigo-600 hover:bg-indigo-500 text-white py-1 px-2 rounded transition-colors flex items-center justify-center gap-1"><Search className="w-3 h-3" /> å‰å¾€ Yahoo è‚¡å¸‚æŸ¥è©¢</a>
                                    </div>
                                ) : (
                                    <p className="text-lg font-bold text-white font-mono flex items-center justify-center gap-2">
                                        <span className="bg-slate-700 px-2 rounded text-cyan-300">{lookupResult.code}</span>=<span className="text-yellow-400">{lookupResult.name}</span>
                                    </p>
                                )}
                            </div>
                        )}
                    </div>
                </div>
                <div className="flex bg-slate-900/80 p-1.5 rounded-xl border border-slate-700/50 gap-1 overflow-x-auto w-full no-scrollbar">
                    {filters.map((filter) => (
                        <button key={filter.id} onClick={() => setActiveFilter(filter.id)} className={`flex-1 px-4 py-3 rounded-lg text-xs font-bold transition-all whitespace-nowrap flex items-center justify-center gap-2 ${activeFilter === filter.id ? `${filter.bg} ${filter.color} border ${filter.border} shadow-lg shadow-${filter.border.split('-')[1]}-500/20 scale-[1.02]` : 'text-slate-400 hover:text-white hover:bg-slate-800'}`}>
                            {filter.id === 'most_active' && <Activity className="w-3 h-3" />}
                            {filter.id === 'top_gainers' && <TrendingUp className="w-3 h-3" />}
                            {filter.id === 'top_losers' && <TrendingDown className="w-3 h-3" />}
                            {filter.label}
                        </button>
                    ))}
                </div>
            </div>
            <div key={activeFilter} className="bg-slate-900 rounded-xl overflow-hidden border border-slate-700 shadow-2xl relative min-h-[550px]" ref={containerRef}>
                <div className="absolute inset-0 flex items-center justify-center pointer-events-none z-0"><div className="w-8 h-8 border-4 border-slate-700 border-t-blue-500 rounded-full animate-spin"></div></div>
            </div>
            <div className="mt-3 bg-blue-900/20 border border-blue-500/20 rounded-lg p-3 flex items-start gap-3">
                <Info className="w-5 h-5 text-blue-400 flex-shrink-0 mt-0.5" />
                <div className="text-xs text-slate-400 leading-relaxed"><span className="text-blue-300 font-bold block mb-1">ç‚ºä»€éº¼è¡¨æ ¼è£¡æ²’æœ‰ä¸­æ–‡è‚¡åï¼Ÿ</span>å› è¡¨æ ¼è³‡æ–™ç›´æ¥ä¾†è‡ªåœ‹éš›çœ‹ç›¤è»Ÿé«” (TradingView) çš„å³æ™‚ä¸²æµï¼Œå—é™æ–¼ç€è¦½å™¨å®‰å…¨è¦ç¯„ï¼Œæˆ‘å€‘ç„¡æ³•ç›´æ¥ä¿®æ”¹å…¶å…§éƒ¨æ–‡å­—ã€‚<br/>å»ºè­°æ‚¨å–„ç”¨å³ä¸Šè§’çš„ <span className="text-yellow-400 font-bold">æ™ºèƒ½è§£ç¢¼å™¨</span>ï¼Œè¼¸å…¥ä»£ç¢¼æˆ–è‚¡åå³å¯å¿«é€Ÿå°ç…§ï¼</div>
            </div>
        </div>
    );
}

const SectorLinkageRadar = ({ openChart }) => {
    const [activeTab, setActiveTab] = useState('ai_semi');
    const containerRef = useRef(null);
    const tabData = {
        'ai_semi': { 
            title: 'AI é‹ç®— / æ™¶ç‰‡', 
            symbols: [ { "proName": "NASDAQ:NVDA", "title": "NVIDIA" }, { "proName": "NYSE:TSM", "title": "å°ç©é›»ADR" }, { "proName": "NASDAQ:AMD", "title": "AMD" }, { "proName": "NASDAQ:ARM", "title": "ARM" }, { "proName": "NASDAQ:INTC", "title": "Intel" } ],
            chains: [ { id: 'foundry', name: 'ğŸ‘‘ æ™¶åœ“ä»£å·¥', desc: 'AI æ™¶ç‰‡è£½é€ æ ¸å¿ƒ (Foundry)', tw_targets: [ {c:'2330',n:'å°ç©é›»'},{c:'2303',n:'è¯é›»'},{c:'5347',n:'ä¸–ç•Œå…ˆé€²'},{c:'6770',n:'åŠ›ç©é›»'} ]}, { id: 'ai_server', name: 'ğŸ”¥ AI ä¼ºæœå™¨', desc: 'GB200 çµ„è£ä»£å·¥ (ODM)', tw_targets: [ {c:'2317',n:'é´»æµ·'},{c:'2382',n:'å»£é”'},{c:'3231',n:'ç·¯å‰µ'},{c:'6669',n:'ç·¯ç©'},{c:'2376',n:'æŠ€å˜‰'},{c:'2421',n:'å»ºæº–'},{c:'2354',n:'é´»æº–'},{c:'8210',n:'å‹¤èª '} ]}, { id: 'ip', name: 'ğŸ§  IP çŸ½æ™ºè²¡', desc: 'ASIC/ARM æ¶æ§‹æˆæ¬Š', tw_targets: [ {c:'3661',n:'ä¸–èŠ¯'},{c:'3443',n:'å‰µæ„'},{c:'3035',n:'æ™ºåŸ'},{c:'6643',n:'M31'},{c:'6531',n:'æ„›æ™®'},{c:'3529',n:'åŠ›æ—º'} ]} ]
        },
        'server_net': { 
            title: 'ä¼ºæœå™¨ / ç¶²é€š', 
            symbols: [ { "proName": "NASDAQ:SMCI", "title": "Supermicro" }, { "proName": "NYSE:DELL", "title": "Dell" }, { "proName": "NASDAQ:AVGO", "title": "Broadcom" }, { "proName": "NASDAQ:CSCO", "title": "Cisco" }, { "proName": "NYSE:ANET", "title": "Arista" } ],
            chains: [ { id: 'cpo', name: 'âœ¨ CPO çŸ½å…‰å­', desc: 'å…‰é€šè¨Šæ¨¡çµ„ (Broadcom)', tw_targets: [ {c:'3363',n:'ä¸Šè©®'},{c:'3450',n:'è¯éˆ'},{c:'3163',n:'æ³¢è‹¥å¨'},{c:'6451',n:'è¨ŠèŠ¯'},{c:'4979',n:'è¯æ˜Ÿå…‰'},{c:'3081',n:'è¯äº'},{c:'6442',n:'å…‰è–'},{c:'4908',n:'å‰é¼'} ]}, { id: 'network', name: 'ğŸŒ é«˜é€Ÿäº¤æ›å™¨', desc: '400G/800G äº¤æ›å™¨', tw_targets: [ {c:'2345',n:'æ™ºé‚¦'},{c:'6285',n:'å•Ÿç¢'},{c:'5388',n:'ä¸­ç£Š'},{c:'3596',n:'æ™ºæ˜“'},{c:'2419',n:'ä»²ç¦'} ]}, { id: 'thermal_liquid', name: 'ğŸ’§ æ¶²å†·æ•£ç†±', desc: 'GB200 é—œéµæŠ€è¡“ (Vertiv)', tw_targets: [ {c:'3017',n:'å¥‡é‹'},{c:'3324',n:'é›™é´»'},{c:'8996',n:'é«˜åŠ›'},{c:'6230',n:'è¶…çœ¾'},{c:'3653',n:'å¥ç­–'} ]}, { id: 'thermal_air', name: 'ğŸ’¨ æ°£å†·/é¢¨æ‰‡', desc: 'ä¼ºæœå™¨æ•£ç†±é¢¨æ‰‡', tw_targets: [ {c:'2421',n:'å»ºæº–'},{c:'3338',n:'æ³°ç¢©'},{c:'3483',n:'åŠ›è‡´'} ]} ]
        },
        'pc_material': {
            title: 'PCB / ææ–™',
            symbols: [ { "proName": "NASDAQ:TTMI", "title": "TTM (PCBå¤§å» )" }, { "proName": "NYSE:DD", "title": "DuPont (ææ–™)" }, { "proName": "NASDAQ:AAPL", "title": "Apple (éœ€æ±‚)" } ],
            chains: [ { id: 'ccl', name: 'ğŸŸ¨ CCL éŠ…ç®”åŸºæ¿', desc: 'AI ä¼ºæœå™¨å‡ç´š', tw_targets: [ {c:'2383',n:'å°å…‰é›»'},{c:'6213',n:'è¯èŒ‚'},{c:'6274',n:'å°ç‡¿'} ]}, { id: 'pcb', name: 'ğŸŸ© PCB è¼‰æ¿', desc: 'HDI/ABF', tw_targets: [ {c:'2368',n:'é‡‘åƒé›»'},{c:'3037',n:'æ¬£èˆˆ'},{c:'3189',n:'æ™¯ç¢©'},{c:'8046',n:'å—é›»'},{c:'3044',n:'å¥é¼'} ]}, { id: 'chemical', name: 'ğŸ§ª ç‰¹ç”¨åŒ–å­¸', desc: 'å°ç©é›»ä¾›æ‡‰éˆ', tw_targets: [ {c:'4755',n:'ä¸‰ç¦åŒ–'},{c:'1711',n:'æ°¸å…‰'},{c:'1727',n:'ä¸­è¯åŒ–'},{c:'4770',n:'ä¸Šå“'},{c:'1773',n:'å‹ä¸€'} ]} ]
        },
        'equipment': { 
            title: 'è¨­å‚™ / æ©Ÿå™¨äºº', 
            symbols: [ { "proName": "NASDAQ:AMAT", "title": "æ‡‰ç”¨ææ–™" }, { "proName": "NASDAQ:LRCX", "title": "ç§‘æ—ç ”ç™¼" }, { "proName": "NASDAQ:ASML", "title": "ASML" }, { "proName": "GLOBALX:BOTZ", "title": "æ©Ÿå™¨äººETF" } ],
            chains: [ { id: 'cowos', name: 'ğŸ—ï¸ CoWoS è¨­å‚™', desc: 'å…ˆé€²å°è£è¨­å‚™ (TSMC)', tw_targets: [ {c:'3131',n:'å¼˜å¡‘'},{c:'6187',n:'è¬æ½¤'},{c:'3583',n:'è¾›è€˜'},{c:'3680',n:'å®¶ç™»'},{c:'6196',n:'å¸†å®£'},{c:'6640',n:'å‡è¯'},{c:'3317',n:'é›·ç§‘'},{c:'5443',n:'å‡è±ª'} ]}, { id: 'robot', name: 'ğŸ¤– æ©Ÿå™¨äºº', desc: 'Tesla Optimus/BOTZ', tw_targets: [ {c:'2359',n:'æ‰€ç¾…é–€'},{c:'2464',n:'ç›Ÿç«‹'},{c:'2365',n:'æ˜†ç›ˆ'},{c:'6188',n:'å»£æ˜'},{c:'8374',n:'ç¾…æ˜‡'},{c:'4562',n:'ç©æ¼¢'},{c:'8234',n:'æ–°æ¼¢'} ]} ]
        },
        'memory': { 
            title: 'è¨˜æ†¶é«”', 
            symbols: [ { "proName": "NASDAQ:MU", "title": "ç¾å…‰" }, { "proName": "NASDAQ:WDC", "title": "WD" }, { "proName": "NASDAQ:STX", "title": "Seagate" } ],
            chains: [ { id: 'dram', name: 'ğŸ’¾ DRAM/NAND', desc: 'HBM éœ€æ±‚ (ç¾å…‰)', tw_targets: [ {c:'2408',n:'å—äºç§‘'},{c:'2344',n:'è¯é‚¦é›»'},{c:'3260',n:'å¨å‰›'},{c:'4967',n:'åéŠ“'},{c:'8299',n:'ç¾¤è¯'},{c:'2337',n:'æ—ºå®'},{c:'2451',n:'å‰µè¦‹'},{c:'8150',n:'å—èŒ‚'} ]} ]
        },
        'power_energy': {
            title: 'é‡é›» / ç¶ èƒ½ (æ–°)',
            symbols: [ { "proName": "NYSE:VST", "title": "Vistra (æ ¸é›»)" }, { "proName": "NASDAQ:CEG", "title": "Constellation" }, { "proName": "NYSE:GE", "title": "GE Vernova" } ],
            chains: [ { id: 'power', name: 'âš¡ é‡é›»/é›»ç¶²', desc: 'ç¾åœ‹é›»ç¶²æ›´æ–°', tw_targets: [ {c:'1513',n:'ä¸­èˆˆé›»'},{c:'1519',n:'è¯åŸ'},{c:'1503',n:'å£«é›»'},{c:'1504',n:'æ±å…ƒ'},{c:'1609',n:'å¤§äº'},{c:'1605',n:'è¯æ–°'} ]}, { id: 'green', name: 'ğŸƒ ç¶ èƒ½/å„²èƒ½', desc: 'è³‡æ–™ä¸­å¿ƒé›»åŠ›', tw_targets: [ {c:'6806',n:'æ£®å´´'},{c:'3708',n:'ä¸Šç·¯'},{c:'9958',n:'ä¸–ç´€é‹¼'},{c:'6282',n:'åº·èˆ’'} ]} ]
        },
        'pc_mobile': {
            title: 'é‚Šç·£ AI / å…‰å­¸ (æ–°)',
            symbols: [ { "proName": "NASDAQ:AAPL", "title": "Apple" }, { "proName": "NYSE:DELL", "title": "Dell" }, { "proName": "NYSE:HPQ", "title": "HP" } ],
            chains: [ { id: 'aipc', name: 'ğŸ’» AI PC/NB', desc: 'æ›æ©Ÿæ½®', tw_targets: [ {c:'2353',n:'å®ç¢'},{c:'2357',n:'è¯ç¢©'},{c:'2324',n:'ä»å¯¶'},{c:'2382',n:'å»£é”'},{c:'3231',n:'ç·¯å‰µ'} ]}, { id: 'optics', name: 'ğŸ“· å…‰å­¸é¡é ­', desc: 'Vision Pro/æ‰‹æ©Ÿ', tw_targets: [ {c:'3008',n:'å¤§ç«‹å…‰'},{c:'3406',n:'ç‰æ™¶å…‰'},{c:'3362',n:'å…ˆé€²å…‰'},{c:'3504',n:'æšæ˜å…‰'} ]} ]
        }
    };
    
    const currentTabData = tabData[activeTab];
    
    useEffect(() => {
        let container = containerRef.current;
        if (!currentTabData || !container) return;

        container.innerHTML = ''; 
        const widgetDiv = document.createElement('div');
        widgetDiv.className = 'tradingview-widget-container';
        widgetDiv.style.width = '100%';
        widgetDiv.style.height = '320px';
        container.appendChild(widgetDiv);
        const script = document.createElement('script');
        script.src = 'https://s3.tradingview.com/external-embedding/embed-widget-market-quotes.js'; 
        script.async = true;
        script.innerHTML = JSON.stringify({ "width": "100%", "height": 320, "symbolsGroups": [ { "name": currentTabData.title, "symbols": currentTabData.symbols.map(s => ({ "name": s.proName, "displayName": s.title })) } ], "showSymbolLogo": true, "colorTheme": "dark", "isTransparent": true, "locale": "zh_TW" });
        widgetDiv.appendChild(script);

        return () => {
            if(container) container.innerHTML = '';
        }
    }, [activeTab, currentTabData]);

    if (!currentTabData) return null;

    return (
        <div className="animate-fadeIn space-y-4">
            <div className="bg-slate-800/50 border border-slate-700/50 rounded-2xl p-4">
                <div className="flex flex-col md:flex-row items-center justify-between gap-4 mb-4">
                    <div className="flex items-center gap-3">
                        <div className="p-2 bg-indigo-600 rounded-lg shadow-lg"><Radar className="w-5 h-5 text-white" /></div>
                        <div><h2 className="text-xl font-bold text-white">ç¾å°ç”¢æ¥­é€£å‹•æˆ°æƒ…å®¤</h2><p className="text-slate-400 text-xs">å³æ™‚ç›£æ§ï¼šä¸Šæ–¹ç‚ºç¾è‚¡é ˜é ­ç¾Šï¼Œä¸‹æ–¹ç‚ºå°æ‡‰å°è‚¡ä¾›æ‡‰éˆã€‚</p></div>
                    </div>
                    <div className="flex gap-2 overflow-x-auto no-scrollbar w-full md:w-auto pb-2">
                        {[ { id: 'ai_semi', label: 'AI é‹ç®—', icon: <Cpu size={14} /> }, { id: 'server_net', label: 'ä¼ºæœå™¨/CPO', icon: <Server size={14} /> }, { id: 'memory', label: 'è¨˜æ†¶é«”', icon: <CircuitBoard size={14} /> }, { id: 'equipment', label: 'è¨­å‚™/æ©Ÿå™¨äºº', icon: <Zap size={14} /> }, { id: 'pc_material', label: 'PCB/ææ–™', icon: <Layers2 size={14} /> }, { id: 'power_energy', label: 'é‡é›»/ç¶ èƒ½', icon: <BatteryCharging size={14} /> }, { id: 'pc_mobile', label: 'é‚Šç·£/å…‰å­¸', icon: <Monitor size={14} /> } ].map(tab => (
                            <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`px-3 py-1.5 rounded-lg text-xs font-bold flex items-center gap-1.5 transition-all whitespace-nowrap ${ activeTab === tab.id ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-500/30' : 'bg-slate-800 text-slate-400 hover:bg-slate-700 hover:text-white border border-slate-700' }`}> {tab.icon} {tab.label} </button>
                        ))}
                    </div>
                </div>
                <div key={activeTab} ref={containerRef} className="bg-slate-900 rounded-xl overflow-hidden border border-slate-700 min-h-[320px] mb-4"></div>
                <div className="grid grid-cols-1 gap-2">
                        {currentTabData.chains.map((chain) => (
                        <div key={chain.id} className="bg-slate-900/40 border border-slate-700/40 rounded-lg p-2 flex flex-col md:flex-row items-start md:items-center gap-2 hover:bg-slate-800/60 transition-colors group">
                                <div className="md:w-32 flex-shrink-0 flex items-center gap-2 border-r border-slate-700/50 pr-2 mr-2">
                                <div className="w-1 h-8 bg-blue-500 rounded-full"></div>
                                <div className="flex flex-col"><span className="text-sm font-bold text-white leading-tight">{chain.name}</span><span className="text-[10px] text-slate-500">{chain.desc}</span></div>
                                </div>
                                <div className="flex-1 flex flex-wrap gap-1.5">
                                    {chain.tw_targets.map((stock) => (
                                        <button key={stock.c} onClick={() => openChart(stock.c)} className="flex items-center gap-1.5 bg-slate-800 hover:bg-slate-600 border border-slate-600 rounded px-2 py-1 transition-all group/btn" title={`æŸ¥çœ‹ ${stock.n} (${stock.c}) Kç·šåœ–`}>
                                            <span className="text-white text-xs font-bold">{stock.n}</span><span className="text-[10px] text-slate-400 font-mono group-hover/btn:text-white">{stock.c}</span>
                                        </button>
                                    ))}
                                </div>
                        </div>
                        ))}
                </div>
            </div>
        </div>
    );
};

// --- æ¢å¾©è‡ªé¸ç›£æ§ã€å½±éŸ³å°ˆå€ã€é¢¨éšªè¨ˆç®—æ©Ÿã€å‚™ä»½ä¸­å¿ƒã€æ•¸æ“šçµ±è¨ˆ ---
const AnalystVideoWall = () => {
    const openShorts = (analyst) => {
        const url = analyst.customUrl || `https://www.youtube.com/results?search_query=${encodeURIComponent(analyst.query + ' shorts')}&sp=CAI%253D`;
        const width = 500, height = 900;
        const left = (window.screen.width - width) / 2;
        const top = (window.screen.height - height) / 2;
        window.open(url, analyst.name, `toolbar=no,location=no,status=no,menubar=no,scrollbars=yes,resizable=yes,width=${width},height=${height},top=${top},left=${left}`);
    };
    const analysts = [
        { id: 1, name: 'æ—ç¿é–åˆ†æå¸«-John', title: 'è¶¨å‹¢ç”¢æ¥­åˆ†æå¸«', query: 'æ—ç¿é–åˆ†æå¸«-John', customUrl: 'https://www.youtube.com/@-john4000/shorts', desc: 'æ“…é•·æŒ–æ˜ç”¢æ¥­è¶¨å‹¢èˆ‡é¡Œæè‚¡ï¼ŒShorts æ›´æ–°é »ç‡é«˜ï¼Œé©åˆçŸ­ç·šé¡Œæè¿½è¹¤ã€‚', color: 'from-fuchsia-600 to-purple-700', badgeColor: 'text-fuchsia-300 border-fuchsia-500/30 bg-fuchsia-500/10', btnColor: 'bg-gradient-to-r from-fuchsia-600 to-purple-600 hover:from-fuchsia-500 hover:to-purple-500 shadow-fuchsia-500/25', avatar: 'J' },
        { id: 2, name: 'è‚¡å¸‚è±ç¥æ¦œ', title: 'æŠ€è¡“åˆ†æé”äºº', query: 'è‚¡å¸‚è±ç¥æ¦œ', customUrl: 'https://www.youtube.com/@fsb688/videos', desc: 'ä¸»è¦è¬›è§£å¤§ç›¤ç±Œç¢¼èˆ‡æŠ€è¡“å‹æ…‹ï¼Œè§€é»çŠ€åˆ©ç›´æ¥ã€‚', color: 'from-cyan-500 to-blue-600', badgeColor: 'text-cyan-300 border-cyan-500/30 bg-cyan-500/10', btnColor: 'bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 shadow-cyan-500/25', avatar: 'F' },
        { id: 3, name: 'æ¸¸åº­çš“çš„è²¡ç¶“çš“è§’', title: 'ç¸½ç¶“è¶¨å‹¢å¤§å¸«', query: 'æ¸¸åº­çš“', customUrl: 'https://www.youtube.com/@yutinghaofinance', desc: 'æ—©æ™¨ç›´æ’­è§£è®€è²¡ç¶“æ™‚äº‹ï¼Œæ“…é•·ç¸½é«”ç¶“æ¿Ÿèˆ‡é€±æœŸå¾ªç’°åˆ†æï¼Œé©åˆæŒæ¡å¤§å±€ã€‚', color: 'from-violet-600 to-indigo-700', badgeColor: 'text-violet-300 border-violet-500/30 bg-violet-500/10', btnColor: 'bg-gradient-to-r from-violet-600 to-indigo-600 hover:from-violet-500 hover:to-indigo-500 shadow-violet-500/25', avatar: 'Y' }
    ];
    return (
        <div className="animate-fadeIn mb-8">
            <div className="bg-slate-900 border border-slate-700/50 rounded-3xl p-6 md:p-8 shadow-2xl relative overflow-hidden">
                <div className="absolute top-0 right-0 w-64 h-64 bg-blue-900/20 rounded-full blur-3xl -translate-y-1/2 translate-x-1/3 pointer-events-none"></div>
                <div className="absolute bottom-0 left-0 w-64 h-64 bg-purple-900/20 rounded-full blur-3xl translate-y-1/2 -translate-x-1/3 pointer-events-none"></div>
                <div className="flex items-center gap-4 mb-8 relative z-10">
                    <div className="p-3 bg-gradient-to-br from-red-500 to-pink-600 rounded-xl shadow-lg shadow-pink-500/20"><Clapperboard className="w-6 h-6 text-white" /></div>
                    <div><h2 className="text-2xl font-bold text-white tracking-wide">åå¸«å½±éŸ³ç‰†</h2><p className="text-slate-400 text-sm">æ¯æ—¥ç›¤å‹¢å¿«è¨Šèˆ‡è¶¨å‹¢å€‹è‚¡è¿½è¹¤</p></div>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-6 relative z-10">
                    {analysts.map((item) => (
                        <div key={item.id} className="group relative bg-slate-800/80 backdrop-blur-sm rounded-2xl overflow-hidden border border-slate-700 hover:border-slate-500 transition-all duration-300 hover:-translate-y-2 shadow-lg hover:shadow-xl flex flex-col h-full">
                            <div className={`h-1.5 w-full bg-gradient-to-r ${item.color}`}></div>
                            <div className="p-6 flex flex-col flex-1">
                                <div className="flex items-center gap-4 mb-4">
                                    <div className="relative">
                                        <div className={`absolute inset-0 bg-gradient-to-br ${item.color} blur opacity-40 rounded-full`}></div>
                                        <div className={`relative w-14 h-14 rounded-full bg-gradient-to-br ${item.color} flex items-center justify-center text-2xl font-bold text-white shadow-inner border border-white/10`}>{item.avatar}</div>
                                    </div>
                                    <div className="flex-1 min-w-0">
                                        <div className="flex-1 min-w-0">
                                            <h3 className="font-bold text-lg text-white leading-tight truncate">{item.name}</h3>
                                            <span className={`text-[10px] px-2 py-0.5 rounded-full mt-1.5 inline-block border ${item.badgeColor} font-medium tracking-wide`}>{item.title}</span>
                                        </div>
                                    </div>
                                </div>
                                <p className="text-slate-400 text-sm mb-6 line-clamp-3 leading-relaxed flex-grow">{item.desc}</p>
                                <div className="border-t border-slate-700/50 mb-5 w-full"></div>
                                <button onClick={() => openShorts(item)} className={`mt-auto w-full py-3.5 text-white rounded-xl font-bold flex items-center justify-center gap-2 transition-all duration-300 hover:scale-[1.02] shadow-lg ${item.btnColor} btn-video-pulse relative overflow-hidden`}>
                                    <PlayCircle className="w-5 h-5 relative z-10" /><span className="relative z-10 tracking-wide">å‰å¾€è§€çœ‹é »é“</span>
                                    <div className="absolute inset-0 bg-gradient-to-t from-black/10 to-white/10 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                                </button>
                            </div>
                        </div>
                    ))}
                </div>
            </div>
        </div>
    );
};

const DataManager = ({ watchlist, setWatchlist }) => {
    const [exportText, setExportText] = useState('');
    const [importText, setImportText] = useState('');
    const [message, setMessage] = useState('');
    const handleExport = () => {
        const randomId = Math.random().toString(36).substring(2, 7).toUpperCase();
        const data = btoa(unescape(encodeURIComponent(JSON.stringify(watchlist))));
        const exportString = `[å°è‚¡æˆ°æƒ…å®¤å‚™ä»½] ID:${randomId} | DATA:${data}`;
        setExportText(exportString);
        
        try {
            const textArea = document.createElement("textarea");
            textArea.value = exportString;
            textArea.style.position = "fixed";
            textArea.style.left = "-9999px";
            textArea.style.top = "0";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            const successful = document.execCommand('copy');
            document.body.removeChild(textArea);
            if (successful) {
                    setMessage(`å‚™ä»½ä»£ç¢¼ (ID: ${randomId}) å·²è¤‡è£½ï¼è«‹ç™¼é€çµ¦æ‚¨çš„æ‰‹æ©Ÿæˆ–å­˜æª”ã€‚`);
            } else {
                    setMessage('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½ä¸‹æ–¹ä»£ç¢¼ã€‚');
            }
        } catch (err) {
            setMessage('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½ä¸‹æ–¹ä»£ç¢¼ã€‚');
        }
        setTimeout(() => setMessage(''), 5000);
    };
    const handleImport = () => { try { const dataPart = importText.split('DATA:')[1]; if (!dataPart) throw new Error('æ ¼å¼éŒ¯èª¤'); const jsonString = decodeURIComponent(escape(atob(dataPart.trim()))); const data = JSON.parse(jsonString); if (Array.isArray(data)) { setWatchlist(data); setMessage('æˆåŠŸé‚„åŸè‡ªé¸è‚¡æ¸…å–®ï¼'); setImportText(''); setTimeout(() => setMessage(''), 3000); } else { throw new Error('è³‡æ–™æ¯€æ'); } } catch (e) { setMessage('éŒ¯èª¤ï¼šç„¡æ•ˆçš„å‚™ä»½ä»£ç¢¼ï¼Œè«‹ç¢ºèªè¤‡è£½å…§å®¹æ˜¯å¦å®Œæ•´ã€‚'); } };
    return (
        <div className="animate-fadeIn space-y-6">
            <div className="bg-slate-800/50 border border-slate-700/50 rounded-2xl p-6 md:p-8">
                <div className="flex items-center gap-3 mb-6"><div className="p-2 bg-slate-600 rounded-lg shadow-lg"><Settings className="w-6 h-6 text-white" /></div><div><h2 className="text-2xl font-bold text-white">æ•¸æ“šå‚™ä»½ä¸­å¿ƒ</h2><p className="text-slate-400 text-sm">è·¨è£ç½®åŒæ­¥è¨­å®š</p></div></div>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div className="bg-slate-900/50 rounded-xl p-6 border border-slate-700"><h3 className="text-lg font-bold text-blue-400 mb-4 flex items-center gap-2"><Upload className="w-5 h-5" /> åŒ¯å‡º / å‚™ä»½</h3><p className="text-sm text-slate-400 mb-4">é»æ“ŠæŒ‰éˆ•è¤‡è£½æ‚¨çš„è‡ªé¸è‚¡ä»£ç¢¼ã€‚</p><button onClick={handleExport} className="w-full py-3 bg-blue-600 hover:bg-blue-500 text-white rounded-lg font-bold flex items-center justify-center gap-2 transition-colors mb-4"><Copy className="w-4 h-4" /> ç”¢ç”Ÿä¸¦è¤‡è£½å‚™ä»½ç¢¼</button>{exportText && (<div className="bg-black/30 p-3 rounded text-xs text-slate-400 break-all font-mono border border-slate-700/50 h-24 overflow-y-auto">{exportText}</div>)}</div>
                    <div className="bg-slate-900/50 rounded-xl p-6 border border-slate-700"><h3 className="text-lg font-bold text-emerald-400 mb-4 flex items-center gap-2"><Download className="w-5 h-5" /> åŒ¯å…¥ / é‚„åŸ</h3><p className="text-sm text-slate-400 mb-4">åœ¨ä¸‹æ–¹è²¼ä¸Šå‚™ä»½ä»£ç¢¼ã€‚</p><textarea value={importText} onChange={(e) => setImportText(e.target.value)} placeholder="åœ¨æ­¤è²¼ä¸Šå‚™ä»½ä»£ç¢¼..." className="w-full h-24 bg-slate-800 border border-slate-600 rounded-lg p-3 text-white text-sm focus:outline-none focus:border-emerald-500 mb-4 font-mono"></textarea><button onClick={handleImport} className="w-full py-3 bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg font-bold flex items-center justify-center gap-2 transition-colors"><CheckCircle2 className="w-4 h-4" /> åŸ·è¡ŒåŒ¯å…¥</button></div></div>
                {message && (<div className="mt-4 p-4 bg-slate-700/80 text-white text-center rounded-lg animate-pulse shadow-lg border border-slate-500">{message}</div>)}
            </div>
        </div>
    );
};

const UsageStats = ({ stats, linkTitleMap }) => {
    const topLinks = Object.entries(stats.linkClicks).sort(([, a], [, b]) => b - a).slice(0, 10);
    const topStocks = Object.entries(stats.stockQueries).sort(([, a], [, b]) => b - a).slice(0, 10);
    return (
        <div className="animate-fadeIn space-y-8">
            <div className="bg-slate-800/50 border border-slate-700/50 rounded-2xl p-6 md:p-8">
                <div className="flex items-center gap-3 mb-6">
                    <div className="p-2 bg-indigo-600 rounded-lg shadow-lg"><BarChart3 className="w-6 h-6 text-white" /></div>
                    <div><h2 className="text-2xl font-bold text-white">å€‹äººä½¿ç”¨çµ±è¨ˆ</h2><p className="text-slate-400 text-sm">è¿½è¹¤æ‚¨çš„åˆ†æç¿’æ…£èˆ‡é—œæ³¨ç„¦é» (è³‡æ–™åƒ…å„²å­˜æ–¼æœ¬æ©Ÿ)</p></div>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div className="bg-slate-900/50 rounded-xl p-6 border border-slate-700">
                        <h3 className="text-lg font-bold text-indigo-400 mb-4 flex items-center gap-2"><Trophy className="w-5 h-5" />æœ€å¸¸ä½¿ç”¨çš„å ±è¡¨</h3>
                        {topLinks.length > 0 ? (
                            <ul className="space-y-3">{topLinks.map(([id, count], index) => (
                                <li key={id} className="flex items-center justify-between p-3 bg-slate-800 rounded-lg border border-slate-700/50 hover:bg-slate-750 transition-colors">
                                    <div className="flex items-center gap-3">
                                        <span className={`w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold ${index < 3 ? 'bg-yellow-500 text-black' : 'bg-slate-700 text-slate-400'}`}>{index + 1}</span>
                                        <span className="text-slate-200 text-sm font-medium">{linkTitleMap[id] || `å ±è¡¨ #${id}`}</span>
                                    </div>
                                    <span className="text-xs font-mono text-indigo-300 bg-indigo-900/30 px-2 py-1 rounded">{count} æ¬¡</span>
                                </li>
                            ))}</ul>
                        ) : (<div className="text-center py-10"><Activity className="w-12 h-12 text-slate-700 mx-auto mb-3" /><p className="text-slate-500">å°šç„¡é»æ“Šç´€éŒ„ï¼Œå¿«å»æ¢ç´¢å ±è¡¨å§ï¼</p></div>)}
                    </div>
                    <div className="bg-slate-900/50 rounded-xl p-6 border border-slate-700">
                        <h3 className="text-lg font-bold text-rose-400 mb-4 flex items-center gap-2"><Flame className="w-5 h-5" />æœ€å¸¸é—œæ³¨çš„è‚¡ç¥¨</h3>
                        {topStocks.length > 0 ? (
                            <ul className="space-y-3">{topStocks.map(([code, count], index) => {
                                const maxCount = Math.max(...Object.values(stats.stockQueries));
                                const percentage = (count / maxCount) * 100;
                                return (
                                    <li key={code} className="flex items-center justify-between p-3 bg-slate-800 rounded-lg border border-slate-700/50 hover:bg-slate-750 transition-colors">
                                        <div className="flex items-center gap-3">
                                            <span className={`w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold ${index < 3 ? 'bg-rose-500 text-white' : 'bg-slate-700 text-slate-400'}`}>{index + 1}</span>
                                            <div className="flex flex-col">
                                                <span className="text-white text-lg font-bold font-mono tracking-wider leading-none">{code}</span>
                                                {STOCK_NAMES[code] && (<span className="text-xs text-slate-400 font-normal mt-0.5">{STOCK_NAMES[code]}</span>)}
                                            </div>
                                        </div>
                                        <div className="flex items-center gap-2">
                                            <div className="h-1.5 w-24 bg-slate-700 rounded-full overflow-hidden hidden sm:block"><div className="h-full bg-rose-500 rounded-full transition-all duration-500" style={{ width: `${percentage}%` }}></div></div>
                                            <span className="text-xs font-mono text-rose-300 min-w-[40px] text-right bg-rose-900/30 px-2 py-1 rounded">{count} æ¬¡</span>
                                        </div>
                                    </li>
                                );
                            })}</ul>
                        ) : (<div className="text-center py-10"><Search className="w-12 h-12 text-slate-700 mx-auto mb-3" /><p className="text-slate-500">å°šç„¡æœå°‹ç´€éŒ„ï¼Œè¼¸å…¥ä»£ç¢¼é–‹å§‹åˆ†æï¼</p></div>)}
                    </div>
                </div>
            </div>
        </div>
    );
};

const WatchlistDashboard = ({ watchlist, setWatchlist, openChart }) => {
    const [inputCode, setInputCode] = useState('');
    const [activeFilter, setActiveFilter] = useState('all');
    
    const addStock = (e) => {
        e.preventDefault();
        const code = inputCode.trim();
        if (code && !watchlist.includes(code)) {
            setWatchlist([...watchlist, code]);
            setInputCode('');
        }
    };
    const removeStock = (code) => { setWatchlist(watchlist.filter(c => c !== code)); };
    const getTheme = (code) => STOCK_THEMES[code] || 'ä¸€èˆ¬ç”¢æ¥­';
    const getThemeStyle = (theme) => {
        if (theme.includes('AI') || theme.includes('ä¼ºæœå™¨') || theme.includes('æ•£ç†±') || theme.includes('IP')) return 'bg-purple-900/40 text-purple-300 border-purple-500/30 shadow-[0_0_10px_rgba(168,85,247,0.15)]';
        if (theme.includes('åŠå°é«”') || theme.includes('CoWoS') || theme.includes('IC') || theme.includes('æ™¶åœ“') || theme.includes('å·¥ç¨‹') || theme.includes('è¨­å‚™')) return 'bg-blue-900/40 text-blue-300 border-blue-500/30 shadow-[0_0_10px_rgba(59,130,246,0.15)]';
        if (theme.includes('é‡é›»') || theme.includes('ç¶ èƒ½') || theme.includes('é›»çºœ') || theme.includes('è®Šå£“å™¨') || theme.includes('é¢¨é›»')) return 'bg-emerald-900/40 text-emerald-300 border-emerald-500/30 shadow-[0_0_10px_rgba(16,185,129,0.15)]';
        if (theme.includes('ç¶²é€š') || theme.includes('CPO') || theme.includes('å…‰') || theme.includes('é€šè¨Š')) return 'bg-cyan-900/40 text-cyan-300 border-cyan-500/30 shadow-[0_0_10px_rgba(6,182,212,0.15)]';
        if (theme.includes('èˆªé‹') || theme.includes('è»å·¥') || theme.includes('èˆªå¤ª')) return 'bg-orange-900/40 text-orange-300 border-orange-500/30 shadow-[0_0_10px_rgba(249,115,22,0.15)]';
        if (theme.includes('ç”ŸæŠ€') || theme.includes('è—¥') || theme.includes('é†«')) return 'bg-rose-900/40 text-rose-300 border-rose-500/30 shadow-[0_0_10px_rgba(244,63,94,0.15)]';
        if (theme.includes('ETF') || theme.includes('é‡‘æ§') || theme.includes('éŠ€è¡Œ')) return 'bg-yellow-900/40 text-yellow-300 border-yellow-500/30 shadow-[0_0_10px_rgba(234,179,8,0.15)]';
        return 'bg-slate-700/50 text-slate-300 border-slate-600/50';
    };
    const filterCategories = [
        { id: 'all', label: 'å…¨éƒ¨' },
        { id: 'ai', label: 'AI / æ•£ç†±', keywords: ['AI', 'ä¼ºæœå™¨', 'æ•£ç†±', 'IP', 'é›»è…¦', 'æ©Ÿæ®¼', 'çµ„è£', 'æ¿å¡'] },
        { id: 'semi', label: 'åŠå°é«” / è¨­å‚™', keywords: ['åŠå°é«”', 'CoWoS', 'IC', 'æ™¶åœ“', 'å°æ¸¬', 'å·¥ç¨‹', 'è¨­å‚™', 'è¨˜æ†¶é«”', 'ææ–™', 'æ¸¬è©¦', 'æ¢é‡'] },
        { id: 'power', label: 'é‡é›» / ç¶ èƒ½', keywords: ['é‡é›»', 'ç¶ èƒ½', 'é›»çºœ', 'è®Šå£“å™¨', 'é¢¨é›»', 'å¤ªé™½èƒ½', 'å„²èƒ½', 'é¦¬é”', 'é–‹é—œ'] },
        { id: 'comm', label: 'ç¶²é€š / CPO', keywords: ['ç¶²é€š', 'CPO', 'å…‰', 'é€šè¨Š', 'äº¤æ›å™¨', 'å¯¬é »'] },
        { id: 'old', label: 'å‚³ç”¢ / èˆªé‹', keywords: ['èˆªé‹', 'è»å·¥', 'èˆªå¤ª', 'é‹¼éµ', 'å¡‘åŒ–', 'ç´¡ç¹”', 'æ°´æ³¥', 'ç‡Ÿå»º', 'è‡ªè¡Œè»Š', 'é‹', 'è¶…å•†', 'æ±½è»Š'] },
        { id: 'finance', label: 'é‡‘è / ETF', keywords: ['é‡‘æ§', 'éŠ€è¡Œ', 'å£½éšª', 'ETF', 'å‚µ', 'è­‰', 'ç§Ÿè³ƒ'] },
        { id: 'bio', label: 'ç”ŸæŠ€', keywords: ['ç”ŸæŠ€', 'è—¥', 'é†«'] }
    ];
    const filteredWatchlist = watchlist.filter(code => {
        if (activeFilter === 'all') return true;
        const theme = getTheme(code);
        const category = filterCategories.find(c => c.id === activeFilter);
        if (!category) return false;
        return category.keywords.some(k => theme.includes(k));
    });
    const getCategoryCount = (categoryId, keywords) => {
        if (categoryId === 'all') return watchlist.length;
        return watchlist.filter(code => {
            const theme = getTheme(code);
            return keywords.some(k => theme.includes(k));
        }).length;
    };
    return (
        <div className="animate-fadeIn space-y-6">
            <div className="bg-slate-800/50 border border-slate-700/50 rounded-2xl p-6 md:p-8">
                <div className="flex flex-col md:flex-row items-center justify-between gap-4 mb-6">
                    <div className="flex items-center gap-3 w-full md:w-auto">
                        <div className="p-2 bg-emerald-600 rounded-lg shadow-lg shrink-0"><ListChecks className="w-6 h-6 text-white" /></div>
                        <div><h2 className="text-2xl font-bold text-white">æ™ºèƒ½è‡ªé¸æˆ°æƒ…å®¤</h2><p className="text-slate-400 text-sm hidden md:block">æ‚¨çš„å€‹äººåŒ–ç”¢æ¥­åœ°åœ– (æœ¬æ©Ÿå„²å­˜)</p></div>
                    </div>
                    <form onSubmit={addStock} className="flex gap-2 w-full md:w-auto">
                        <input type="text" value={inputCode} onChange={(e) => setInputCode(e.target.value)} placeholder="è¼¸å…¥ä»£ç¢¼åŠ å…¥è‡ªé¸..." className="px-4 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white focus:outline-none focus:border-emerald-500 w-full md:w-48 placeholder-slate-500" />
                        <button type="submit" className="px-4 py-2 bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg flex items-center gap-1 transition-colors whitespace-nowrap shadow-md shadow-emerald-900/20"><Plus className="w-4 h-4" /> åŠ å…¥</button>
                    </form>
                </div>
                {watchlist.length > 0 && (
                    <div className="flex overflow-x-auto pb-4 gap-2 mb-2 no-scrollbar">
                        {filterCategories.map(cat => {
                            const count = getCategoryCount(cat.id, cat.keywords);
                            const isActive = activeFilter === cat.id;
                            return (
                                <button key={cat.id} onClick={() => setActiveFilter(cat.id)} className={`flex items-center gap-2 px-4 py-2 rounded-full text-sm font-bold transition-all whitespace-nowrap border ${isActive ? 'bg-emerald-600 text-white border-emerald-500 shadow-lg shadow-emerald-600/25' : 'bg-slate-800 text-slate-400 border-slate-700 hover:bg-slate-700 hover:text-slate-200'} ${count === 0 && cat.id !== 'all' ? 'opacity-50 grayscale' : ''}`}>
                                    {cat.label}<span className={`text-xs px-1.5 py-0.5 rounded-full ${isActive ? 'bg-white/20 text-white' : 'bg-slate-900 text-slate-500'}`}>{count}</span>
                                </button>
                            );
                        })}
                    </div>
                )}
                {filteredWatchlist.length > 0 ? (
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        {filteredWatchlist.map(code => {
                            const theme = getTheme(code);
                            const themeStyle = getThemeStyle(theme);
                            return (
                                <div key={code} className="bg-slate-900 border border-slate-700 rounded-xl p-4 hover:border-emerald-500/50 transition-all hover:shadow-lg group relative animate-fadeIn">
                                    <button onClick={(e) => { e.stopPropagation(); removeStock(code); }} className="absolute top-3 right-3 text-slate-600 hover:text-red-400 transition-colors opacity-0 group-hover:opacity-100 p-1" title="ç§»é™¤"><Trash2 className="w-4 h-4" /></button>
                                    <div className="flex justify-between items-start mb-4">
                                        <div><span className="text-2xl font-bold text-white font-mono tracking-wide block">{code}</span><span className="text-sm text-slate-400 font-medium">{STOCK_NAMES[code] || 'è‡ªé¸å€‹è‚¡'}</span></div>
                                    </div>
                                    <div className="mb-4"><div className={`inline-flex items-center gap-1.5 px-3 py-1.5 rounded-lg border text-xs font-bold tracking-wide w-full justify-center ${themeStyle}`}><Flame className="w-3 h-3" />{theme}</div></div>
                                    <div className="grid grid-cols-2 gap-2">
                                        <button onClick={() => openChart(code)} className="py-2 bg-slate-800 hover:bg-slate-700 text-slate-300 rounded-lg text-sm flex items-center justify-center gap-2 transition-colors border border-slate-700 hover:border-slate-500"><Activity className="w-4 h-4" /> K ç·šåˆ†æ</button>
                                        <button onClick={() => window.open(`https://www.peicheng.com.tw/asp/stockquery/${code}.htm`, '_blank')} className="py-2 bg-emerald-900/30 hover:bg-emerald-900/50 text-emerald-400 border border-emerald-900/50 rounded-lg text-sm flex items-center justify-center gap-2 transition-colors"><Search className="w-4 h-4" /> å¤¢å¹»å ±è¡¨</button>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                ) : (
                    <div className="text-center py-16 border-2 border-dashed border-slate-700 rounded-xl bg-slate-900/30">
                        <ListChecks className="w-16 h-16 text-slate-600 mx-auto mb-4" />
                        <h3 className="text-xl font-bold text-white mb-2">{activeFilter === 'all' ? 'æ‚¨çš„è‡ªé¸æ¸…å–®æ˜¯ç©ºçš„' : 'æ­¤åˆ†é¡å°šç„¡è‡ªé¸è‚¡'}</h3>
                        <p className="text-slate-400">{activeFilter === 'all' ? 'è«‹åœ¨ä¸Šæ–¹è¼¸å…¥ä»£ç¢¼ï¼Œé–‹å§‹æ‰“é€ æ‚¨çš„å°ˆå±¬æˆ°æƒ…å®¤ï¼' : 'è«‹åˆ‡æ›åˆ†é¡æˆ–æ–°å¢ç›¸é—œå€‹è‚¡ã€‚'}</p>
                    </div>
                )}
            </div>
        </div>
    );
};

export default function App() {
    const [activeCategory, setActiveCategory] = useState('all'); 
    const [stockCode, setStockCode] = useState('');
    const [chartSymbol, setChartSymbol] = useState(null);
    
    // Auto-load Marked.js safely
    useEffect(() => {
        if (!window.marked && !document.querySelector('script[src*="marked.min.js"]')) {
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/marked/marked.min.js';
            script.async = true;
            document.head.appendChild(script);
        }
    }, []);

    const [stats, setStats] = useState(() => {
        try {
            const saved = localStorage.getItem('stock_analysis_stats');
            return saved ? JSON.parse(saved) : { linkClicks: {}, stockQueries: {} };
        } catch (e) { return { linkClicks: {}, stockQueries: {} }; }
    });

    const [watchlist, setWatchlist] = useState(() => {
        try {
            const saved = localStorage.getItem('stock_analysis_watchlist');
            const parsed = saved ? JSON.parse(saved) : [];
            // é˜²å‘†æ©Ÿåˆ¶ï¼šç¢ºä¿è®€å–çš„ä¸€å®šæ˜¯é™£åˆ—
            return Array.isArray(parsed) ? parsed : [];
        } catch (e) { 
            console.error("Watchlist load error:", e);
            return []; 
        }
    });

    useEffect(() => { localStorage.setItem('stock_analysis_watchlist', JSON.stringify(watchlist)); }, [watchlist]);
    useEffect(() => { localStorage.setItem('stock_analysis_stats', JSON.stringify(stats)); }, [stats]);

    const trackStockQuery = (code) => { setStats(prev => ({ ...prev, stockQueries: { ...prev.stockQueries, [code]: (prev.stockQueries[code] || 0) + 1 } })); };
    const trackLinkClick = (id) => { setStats(prev => ({ ...prev, linkClicks: { ...prev.linkClicks, [id]: (prev.linkClicks[id] || 0) + 1 } })); };

    const handleSearch = (e) => {
        e.preventDefault();
        const cleanCode = stockCode.trim();
        if (cleanCode) {
            setChartSymbol(cleanCode);
            trackStockQuery(cleanCode);
        }
    };

    const openChartFromWatchlist = (code) => {
        setChartSymbol(code);
        window.scrollTo({ top: 0, behavior: 'smooth' });
    };

    const closeChart = () => {
        setChartSymbol(null);
        setStockCode('');
    };

    const addToWatchlist = (code) => {
        if (code && !watchlist.includes(code)) {
            setWatchlist(prev => [...prev, code]);
            alert(`å·²å°‡ ${code} åŠ å…¥è‡ªé¸ç›£æ§ï¼`);
        } else {
            alert(`${code} å·²åœ¨è‡ªé¸æ¸…å–®ä¸­ã€‚`);
        }
    };

    const personalFavoriteIds = [103, 107, 1, 2, 101, 106];
    const links = useMemo(() => LINKS_DATA, []);
    const linkTitleMap = useMemo(() => links.reduce((acc, link) => { acc[link.id] = link.title; return acc; }, {}), [links]);

    let filteredLinks;
    if (activeCategory === 'all') { 
        filteredLinks = links; 
    } else if (activeCategory === 'favorites') { 
        filteredLinks = personalFavoriteIds.map(id => links.find(link => link.id === id)).filter(item => item !== undefined); 
    } else { 
        filteredLinks = links.filter(link => link.category === activeCategory); 
    }

    return (
        <div className="min-h-screen bg-slate-900 text-slate-100 font-sans p-4 md:p-8 flex flex-col">
            <GlobalStyles />
            <div className="w-full">
                <TradingViewTicker />
            </div>
            <div className="flex-1 w-full max-w-[96%] mx-auto mt-8">
                <header className="mb-8 border-b border-slate-700 pb-6 flex flex-col md:flex-row justify-between items-center md:items-end gap-6">
                    <div className="text-center md:text-left">
                        <h1 className="text-3xl md:text-4xl font-bold bg-gradient-to-r from-blue-400 to-emerald-400 bg-clip-text text-transparent mb-2">å°è‚¡åˆ†æ éš±è—å ±è¡¨æˆ°æƒ…å®¤</h1>
                        <p className="text-slate-400">JAMES å€‹äººæ„›ç”¨æ•´åˆç±Œç¢¼ã€æ³•äººèˆ‡æŠ€è¡“åˆ†æçš„å¿«é€Ÿå•Ÿå‹•ä¸­å¿ƒ <span className="text-xs text-yellow-500 border border-yellow-500/30 px-1 rounded ml-1">PRO+</span></p>
                    </div>
                    <MarketClock />
                </header>

                <div className="mb-10 bg-gradient-to-r from-slate-800 to-slate-800/50 p-6 rounded-2xl border border-blue-500/30 shadow-lg shadow-blue-900/10">
                    <div className="flex flex-col md:flex-row items-start gap-4">
                        <div className="flex items-center gap-3 text-blue-300 min-w-fit h-12"><Zap className="w-6 h-6" /><span className="font-bold text-lg">æŠ€è¡“æˆ°æƒ…æ§åˆ¶å°</span></div>
                        <div className="flex-1 w-full">
                            <form onSubmit={handleSearch} className="flex gap-2">
                                <div className="relative flex-1 flex gap-2"><input type="text" value={stockCode} onChange={(e) => setStockCode(e.target.value)} placeholder="è¼¸å…¥ä»£ç¢¼ (ä¾‹: 2330)" className="flex-1 w-full px-4 py-3 bg-slate-900 border border-slate-600 rounded-lg text-white placeholder-slate-500 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all font-mono tracking-wider" /></div>
                                <button type="submit" className="px-6 py-3 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-lg transition-colors whitespace-nowrap shadow-md hover:shadow-blue-500/25 flex items-center gap-2"><MousePointerClick className="w-4 h-4" />å•Ÿå‹•åˆ†æ</button>
                            </form>
                            <p className="text-slate-500 text-xs mt-2 ml-1">* å°æ’‡æ­¥ï¼šè¼¸å…¥ä»£ç¢¼å¾Œï¼Œæ§åˆ¶å°å°‡é¡¯ç¤ºã€ŒHiStock / ç©è‚¡ç¶² / Yahoo ã€çš„å¿«é€Ÿå•Ÿå‹•æŒ‰éˆ•ã€‚é»æ“Šå¾Œæœƒä»¥ã€Œç¨ç«‹æ‡¸æµ®è¦–çª—ã€é–‹å•Ÿï¼Œä¸æœƒè·³å‡ºæœ¬é é¢ã€‚</p>
                        </div>
                    </div>
                </div>

                {chartSymbol && <ChartLauncher symbol={chartSymbol} onClose={closeChart} />}
                <AIAssistant />

                <div className="flex flex-wrap gap-2 mb-8 justify-center md:justify-start">
                    {[ { id: 'all', label: 'å…¨éƒ¨é¡¯ç¤º' }, 
                    { id: 'favorites', label: 'å€‹äººæ„›ç”¨', icon: <Star size={16} className="inline mr-1 text-yellow-400 fill-yellow-400/20" /> },
                    { id: 'market_info', label: 'å¸‚å ´å³æ™‚', icon: <Signal size={16} className="inline mr-1" /> }, 
                    { id: 'watchlist', label: 'è‡ªé¸ç›£æ§', icon: <ListChecks size={16} className="inline mr-1 text-emerald-400" /> },
                    { id: 'sentiment', label: 'å¤§ç›¤å¤šç©º', icon: <ThermometerSun size={16} className="inline mr-1 text-orange-400" /> },
                    { id: 'live_quant', label: 'AI é‡åŒ–é›·é” (v6.0)', icon: <ScanLine size={16} className="inline mr-1 text-cyan-400" /> },
                    { id: 'theme_hunter', label: 'Alpha é¡Œæçµæ‰‹', icon: <Crosshair size={16} className="inline mr-1 text-red-400" /> },
                    { id: 'video_wall', label: 'å½±éŸ³å°ˆå€', icon: <Youtube size={16} className="inline mr-1 text-red-500" /> }, 
                    { id: 'tw_hot_rank', label: 'å°è‚¡ç†±é–€æ’è¡Œ', icon: <Flame size={16} className="inline mr-1 text-rose-400" /> }, 
                    { id: 'us_sector_radar', label: 'ç¾å°ç”¢æ¥­é€£å‹•', icon: <Radar size={16} className="inline mr-1 text-blue-400" /> },
                    { id: 'chips', label: 'ç±Œç¢¼é›†ä¸­' }, 
                    { id: 'institutional', label: 'æ³•äººå‹•å‘' }, 
                    { id: 'tech', label: 'æŠ€è¡“ç­–ç•¥' }, 
                    { id: 'fundamental', label: 'åŸºæœ¬é¢' }, 
                    { id: 'knowledge', label: 'æŒ‡æ¨™å°ç™¾ç§‘', icon: <GraduationCap size={16} className="inline mr-1" /> }, 
                    { id: 'statistics', label: 'æ•¸æ“šçµ±è¨ˆ', icon: <BarChart3 size={16} className="inline mr-1 text-indigo-400" /> }, 
                    { id: 'data_manage', label: 'ç³»çµ±è¨­å®š', icon: <Settings size={16} className="inline mr-1 text-slate-400" /> } 
                    ].map((tab) => (
                        <button key={tab.id} onClick={() => setActiveCategory(tab.id)} className={`px-4 py-2 rounded-full text-sm font-medium transition-all duration-200 flex items-center ${activeCategory === tab.id ? 'bg-blue-600 text-white shadow-lg shadow-blue-500/25' : 'bg-slate-800 text-slate-400 hover:bg-slate-700 hover:text-white'}`}>{tab.icon}{tab.label}</button>
                    ))}
                </div>

                {/* æ ¹æ“š activeCategory é¡¯ç¤ºå…§å®¹ */}
                {activeCategory === 'theme_hunter' ? (<AlphaHunterPro openChart={openChartFromWatchlist} />) : 
                activeCategory === 'watchlist' ? (<WatchlistDashboard watchlist={watchlist} setWatchlist={setWatchlist} openChart={openChartFromWatchlist} />) : 
                activeCategory === 'live_quant' ? (<LiveQuantScanner openChart={openChartFromWatchlist} addToWatchlist={addToWatchlist} />) :
                activeCategory === 'video_wall' ? (<AnalystVideoWall />) : 
                activeCategory === 'statistics' ? (<UsageStats stats={stats} linkTitleMap={linkTitleMap} />) : 
                activeCategory === 'data_manage' ? (<DataManager watchlist={watchlist} setWatchlist={setWatchlist} />) :
                activeCategory === 'tw_hot_rank' ? (<TWHotLists />) : 
                activeCategory === 'us_sector_radar' ? (<SectorLinkageRadar openChart={openChartFromWatchlist} />) : 
                activeCategory === 'sentiment' ? (<MarketSentimentGauge />) :
                (
                    <div className="space-y-12">
                        {activeCategory === 'knowledge' && (
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6 animate-fadeIn mb-8">
                                <div className="md:col-span-2 bg-gradient-to-r from-blue-900/30 to-purple-900/30 p-6 rounded-xl border border-blue-500/20 mb-2">
                                    <div className="flex items-center gap-3 mb-2 text-blue-300"><BookOpen className="w-6 h-6" /><h2 className="text-2xl font-bold">è‚¡å¸‚è§£è®€æŒ‡å—</h2></div>
                                    <p className="text-slate-300">æ•´ç†äº†å ±è¡¨ä¸­å¸¸è¦‹çš„å°ˆæ¥­è¡“èªï¼Œå¹«åŠ©æ‚¨å¿«é€Ÿçœ‹æ‡‚ã€Œç¶œåˆè©•åˆ†ã€èˆ‡ã€Œå¸‚å ´æ•¸æ“šã€èƒŒå¾Œçš„æ„ç¾©ã€‚</p>
                                </div>
                                {KNOWLEDGE_ITEMS.map((item, index) => (
                                    <div key={index} className="bg-slate-800 rounded-xl p-6 border border-slate-700 hover:border-pink-500/30 transition-all shadow-lg">
                                        <div className="flex items-start gap-4 mb-4">
                                            <div className="p-3 bg-slate-900 rounded-lg shadow-inner">{item.icon}</div>
                                            <div><h3 className="text-xl font-bold text-white mb-1">{item.title}</h3><p className="text-pink-300 font-medium text-sm">{item.summary}</p></div>
                                        </div>
                                        <ul className="space-y-2">{item.details.map((detail, idx) => (<li key={idx} className="flex items-start gap-2 text-slate-400 text-sm"><span className="w-1.5 h-1.5 bg-slate-600 rounded-full mt-1.5 flex-shrink-0" /><span>{detail}</span></li>))}</ul>
                                    </div>
                                ))}
                            </div>
                        )}

                        {(activeCategory === 'fundamental' || activeCategory === 'all') && (
                            <div className="bg-amber-900/20 border border-amber-600/30 p-4 rounded-xl flex items-start gap-3">
                                <CalendarClock className="w-6 h-6 text-amber-500 flex-shrink-0 mt-1" />
                                <div><h3 className="text-amber-400 font-bold text-sm mb-1">é—œæ–¼ã€Œæœ€æ–°æ•¸æ“šã€çš„èªªæ˜</h3><p className="text-slate-300 text-xs leading-relaxed">å®˜æ–¹å­£å ±è³‡æ–™è‹¥åœåœ¨ 11 æœˆå±¬æ­£å¸¸ç¾è±¡ï¼ˆå›  Q4 è²¡å ±å°šæœªå‡ºçˆï¼‰ã€‚<br/>è‹¥è¦çœ‹æœ€æ–°çš„ <span className="text-white font-bold">12æœˆç‡Ÿæ”¶</span>ï¼Œè«‹é»é¸ä¸‹æ–¹æ¨™ç¤ºç‚º <span className="text-rose-400 font-bold">Goodinfo</span> çš„å¤–éƒ¨è³‡æºï¼Œå®ƒæä¾›å°è‚¡æœ€å³æ™‚çš„ç‡Ÿæ”¶æ›´æ–°ã€‚</p></div>
                            </div>
                        )}
                        
                        {activeCategory !== 'knowledge' && (
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                {filteredLinks.map((link) => (
                                    <div key={link.id} onClick={(e) => { e.stopPropagation(); trackLinkClick(link.id); window.open(link.url, '_blank'); }} className={`group rounded-xl p-6 border transition-all duration-300 hover:-translate-y-1 shadow-xl relative overflow-hidden cursor-pointer ${link.tag?.includes('å¤–éƒ¨è³‡æº') ? 'bg-slate-800/80 border-rose-500/30 hover:border-rose-500 hover:bg-slate-800' : link.category === 'market_info' ? 'bg-slate-800 border-indigo-500/30 hover:border-indigo-400 hover:bg-slate-800/90' : 'bg-slate-800 border-slate-700 hover:border-blue-500/50 hover:bg-slate-800/80'}`}>
                                            {link.tag?.includes('å¤–éƒ¨è³‡æº') && (<div className="absolute top-0 right-0 w-16 h-16 bg-gradient-to-bl from-rose-500/20 to-transparent rounded-bl-full pointer-events-none" />)}
                                            <div className="flex justify-between items-start mb-4">
                                                <div className="p-3 bg-slate-900 rounded-lg group-hover:scale-110 transition-transform duration-300">{link.icon}</div>
                                                {link.tag && (<span className={`px-2 py-1 text-xs rounded border ${link.tag.includes('å¤–éƒ¨è³‡æº') ? 'bg-rose-900/30 text-rose-300 border-rose-800 font-bold animate-pulse-slow' : link.category === 'market_info' ? 'bg-indigo-900/30 text-indigo-300 border-indigo-800' : link.tag === 'åƒ¹å€¼æŠ•è³‡' || link.tag === 'å®˜æ–¹å­£å ±' ? 'bg-cyan-900/30 text-cyan-300 border-cyan-800' : 'bg-slate-700 text-blue-300 border-slate-600'}`}>{link.tag}</span>)}
                                            </div>
                                            <h3 className="text-xl font-bold text-white mb-2 group-hover:text-blue-400 transition-colors">{link.title}</h3>
                                            <p className="text-slate-400 text-sm mb-6 leading-relaxed h-16 overflow-hidden">{link.description}</p>
                                            <a href={link.url} target="_blank" rel="noopener noreferrer" onClick={(e) => { e.stopPropagation(); trackLinkClick(link.id); }} className={`flex items-center justify-center w-full py-3 text-white rounded-lg font-medium transition-colors gap-2 ${link.tag?.includes('å¤–éƒ¨è³‡æº') ? 'bg-rose-600 hover:bg-rose-500' : link.category === 'market_info' ? 'bg-indigo-600 hover:bg-indigo-500' : 'bg-blue-600 hover:bg-blue-500'}`}><span>é–‹å•Ÿå ±è¡¨</span><ExternalLink size={16} /></a>
                                    </div>
                                ))}
                            </div>
                        )}

                        {activeCategory === 'fundamental' && (
                            <div className="animate-fadeIn mt-8">
                                <div className="flex items-center gap-2 mb-6 border-b border-slate-700 pb-2"><ClipboardList className="w-6 h-6 text-cyan-400" /><h2 className="text-xl font-bold text-cyan-400">åŸºæœ¬é¢é—œéµæŒ‡æ¨™è§£æ</h2><span className="text-slate-500 text-sm ml-2">- åƒ¹å€¼æŠ•è³‡äººå¿…å‚™è¾­å…¸</span></div>
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">{FUNDAMENTAL_TERMS.map((term, index) => (<div key={index} className="bg-slate-800/60 p-5 rounded-lg border border-slate-700/50 hover:bg-slate-800 transition-colors"><div className="flex items-center gap-2 mb-2">{term.icon}<h3 className="font-bold text-white text-base">{term.title}</h3></div><p className="text-xs text-cyan-300 mb-2 font-medium">{term.sub}</p><p className="text-slate-400 text-sm leading-relaxed">{term.desc}</p></div>))}</div>
                            </div>
                        )}
                    </div>
                )}
                
                <div className="mt-12 bg-slate-800/50 rounded-xl p-6 border border-slate-700/50">
                    <div className="flex items-center gap-2 mb-4 text-emerald-400"><Info size={20} /><h3 className="font-bold">åˆ†æå»ºè­°æµç¨‹</h3></div>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm text-slate-300">
                        <div className="bg-slate-900/50 p-4 rounded-lg"><span className="text-blue-400 font-bold block mb-1">Step 1. ç›¤å‰å¿«ç¯©</span>ç€è¦½ <span className="text-white">åå¸«å½±éŸ³ç‰†</span> æŒæ¡æœ€æ–°è¶¨å‹¢ï¼Œä¸¦åˆ©ç”¨ <span className="text-white">å®Œæ•´æŠ€è¡“åˆ†æ</span> å°é—œæ³¨å€‹è‚¡é€²è¡Œå¿«é€Ÿå¥è¨ºã€‚</div>
                        <div className="bg-slate-900/50 p-4 rounded-lg"><span className="text-blue-400 font-bold block mb-1">Step 2. ç›¤å¾Œç±Œç¢¼</span>æ”¶ç›¤å¾Œæª¢æŸ¥ <span className="text-white">ç±Œç¢¼é›†ä¸­åº¦</span> èˆ‡ <span className="text-white">æ³•äººè²·è³£è¶…</span>ï¼Œç¢ºèªä¸»åŠ›å¤§æˆ¶è³‡é‡‘æ˜¯å¦é€²é§ã€‚</div>
                        <div className="bg-slate-900/50 p-4 rounded-lg"><span className="text-blue-400 font-bold block mb-1">Step 3. è³‡é‡‘ç­–ç•¥</span>è§€å¯Ÿ <span className="text-white">æˆäº¤é‡æ’è¡Œ</span> èˆ‡ <span className="text-white">å¤šç©ºé¸è‚¡</span> æ¸…å–®ï¼Œæ‰¾å‡ºå¸‚å ´ç†±éŒ¢æµå‘ï¼Œæ“¬å®šæ“ä½œç­–ç•¥ã€‚</div>
                    </div>
                </div>
                
                <footer className="mt-12 text-center text-slate-500 text-sm"><p>æ­¤ç¶²ç«™ç‚ºé€£çµæ•´åˆå·¥å…·ï¼Œä¸å…·å‚™å•†æ¥­æ€§è³ªï¼Œåƒ…ä¾›æˆ‘ä½¿ç”¨ã€‚</p></footer>
            </div>
        </div>
    );
}